<!DOCTYPE html>
<html>
<head>
    <title>Long Straddle Strategy Profit/Loss Chart</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.0.2/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
    <h1>Long Straddle Strategy Profit/Loss Chart</h1>
    <div class="main_chart" style="width: 80vw; height: 50vh;">
        <canvas id="straddleChart"></canvas>
    </div>
    <script>
        $(document).ready(function() {
            // Function to update the chart with new data
            function updateChart(data) {
                var assetPrices = data.stock_price_range;
                var profits = data.profits;

                var chartData = {
                    labels: assetPrices,
                    datasets: [{
                        label: 'Profit/Loss',
                        data: profits,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        borderDash: [5, 5], // Border style - dashed
                        pointRadius: 0,
                        fill: false,
                    }, {
                        // Horizontal line at zero profit
                        type: 'line',
                        label: 'Zero Profit',
                        data: Array(assetPrices.length).fill(0),
                        borderColor: 'black',
                        borderWidth: 1,
                 
                        fill: false,
                    }]
                };

                var options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Asset Price'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Profit/Loss'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            intersect: false,
                            mode: 'index',
                            callbacks: {
                                title: function(context) {
                                    return 'Asset Price: ' + context[0].label;
                                },
                                label: function(context) {
                                    var datasetLabel = context.dataset.label || '';
                                    return datasetLabel + ': ' + context.parsed.y.toFixed(2);
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        annotation: {
                            drawTime: 'afterDatasetsDraw',
                            annotations: []
                        }
                    }
                };

                var ctx = document.getElementById('straddleChart').getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: options
                });

                // Add a vertical line at the current asset value
                var currentValue = data.current_asset_value;
                var index = assetPrices.indexOf(currentValue);

                if (index >= 0) {
                    var xPos = myChart.scales.x.getPixelForValue(currentValue);
                    var drawVerticalLine = function() {
                        var linePos = myChart.scales.x.left + xPos;
                        ctx.beginPath();
                        ctx.moveTo(linePos, myChart.scales.y.top);
                        ctx.lineTo(linePos, myChart.scales.y.bottom);
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.7)';
                        ctx.stroke();
                    };
                    drawVerticalLine();

                    myChart.options.animation.onComplete = drawVerticalLine;
                    myChart.update();
                }
            }

            // Fetch data using Ajax
            $.ajax({
                url: '/straddle_data',
                method: 'GET',
                dataType: 'json',
                success: function(data) {
                    updateChart(data);
                },
                error: function() {
                    alert('Failed to fetch data.');
                }
            });
        });
    </script>
</body>
</html>
