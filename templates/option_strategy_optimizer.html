{% extends "base_dashboard.html" %} {% load static %} {% block dashboard_body %}
<style>
    .day_1 {
        border-radius: 4px;
        color: white;
        background: cornflowerblue;
        width: fit-content;
        height: 28px;
        padding: 0 6px 0 5px;
        transition: 0.3s;
        cursor: pointer;
        display: flex;
        align-items: center;
    }

    .day_1:hover {
        color: cornflowerblue;
        border: 1px solid cornflowerblue;
        background: transparent;
    }

    .button_left_simu,
    .button_right_simu {
        display: flex;
        gap: 1rem;
    }

    .main_all_button_filter {
        display: flex;
        justify-content: space-between;
    }

    .pre_built_simu {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 1rem 0;
        gap: 0.5rem;
        padding: 17px 14px;
    }



    .straddle {
        color: #4399eb;
        border: 1px solid #4399eb;
        background-color: #fff;
        -webkit-box-shadow: none;
        box-shadow: none;
        -webkit-transition: .3s;
        -moz-transition: .3s;
        transition: .3s;
        outline: 0;
        padding: 5px 7px;
        cursor: pointer;
        border-radius: 5px;
    }

    .straddle:hover {
        background: linear-gradient(180deg, #4399eb, #5cadfb) !important;
        color: #fff !important;
    }

    .option_strategies_active {
        background: linear-gradient(180deg, #4399eb, #5cadfb) !important;
        color: #fff !important;
    }

    .success_cvr {
        background: #90eeae65 !important;
        color: rgb(13, 162, 0);
    }

    .danger_cvr {
        background: #ff000054 !important;
        color: red;
    }
</style>
<style>
    p {
        margin-bottom: auto !important;
    }

    .main_option_chain_table {
        height: 400px;
        overflow: auto;
        margin: 1rem 0;
    }

    .bg-light-green {
        background-color: #c9ffed !important;
    }

    .bg-light-red {
        background-color: #ffd2cf !important;
    }

    #put_call_put {
        right: 0;
    }

    .put_call_btns {
        outline: none;
        border: none !important;
        height: 30px !important;
        margin: 2px 0 0 0 !important;
        color: black !important;
        transition: 0.3s;
    }

    .call-pul-ltp-btns {
        gap: 0.5rem !important;
        display: none;
    }

    .main_option_chain_table table thead tr th {
        font-size: 14px !important;
        color: #000000a3 !important;
        font-family: system-ui !important;
    }

    .strategy_option_chain tr td {
        font-size: 13px;
        font-weight: 700;
        color: #0000009e;
        font-family: system-ui;
    }

    .call_put_tr:hover .call-pul-ltp-btns {
        display: flex !important;
    }

    .strategy_table_input {
        padding-bottom: 1rem !important;
        display: flex;
        row-gap: 0.5rem;
        column-gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        align-items: center;
    }

    .add-btn {
        font-size: 22px;
        position: relative;
        /* background: linear-gradient(180deg,#4399eb,#5cadfb)!important;  */
        color: #4399eb;
        height: auto;
        width: auto;
    }

    .delete-btn {
        margin-left: 9px;
        font-size: 22px;
        color: #ed0000;
    }
</style>
<style>
    .option_chain_strategies,
    .main_max_pain_strategies,
    .lot_size_strategies,
    .spot_strategies {
        font-size: 12px;
        font-weight: 700;
        color: #00000099;
    }

    .main_top_all_left_right {
        flex-wrap: wrap;
        row-gap: 1rem;
    }

    .main_top_strategies {
        flex-wrap: wrap;
    }

    .strategy_simu {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .right_side_top_strategies {

        display: flex;
        flex-wrap: wrap;
        row-gap: 0.5rem;
        column-gap: 1rem;
    }

    #spot_arrow {
        font-family: boxicons !important;
        font-weight: 600;
        font-style: normal;
        font-variant: normal;
        line-height: 1;
        text-rendering: auto;
        display: inline-block;
        font-size: 10px !important;
        text-transform: none;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
</style>
<div class="title my-2">
    <h5>Option Strategy Optimizer</h5>
</div>
<div class="top_content_option_chain p-3 shadow">
    <div class="main_top_all_left_right d-flex align-items-center justify-content-between">
        <div class="left_side_top_strategies">
            <div class="main_top_strategies d-flex align-items-center gap-4">
                <select id="stockDropdown" class="form-select w-auto">
                    <optgroup label="Indices">
                        <option value="NIFTY">NIFTY</option>
                        <option value="BANKNIFTY">BANKNIFTY</option>
                        <option value="FINNIFTY">FINNIFTY</option>
                    </optgroup>
                    <optgroup label="Stocks"></optgroup>
                </select>
                <div class="option_chain_strategies d-flex align-items-center gap-1">
                    <p>Option Chain</p>
                    <i class="bx bx-link-external"></i>
                </div>
                <div class="main_max_pain_strategies d-block">
                    <div class="max_pain_strategies d-flex align-items-center gap-1">
                        <p>Max Pain</p>
                        <i class="bx bx-link-external"></i>
                    </div>
                    <div id="max_pain_value"></div>
                </div>
                <div class="lot_size_strategies d-block">
                    <p>Lot Size</p>
                    <div id="lot_size_value"></div>
                </div>

                <div class="spot_strategies">
                    <p>Spot</p>

                    <div id="spot_value"></div>
                </div>
            </div>
        </div>
        <div class="right_side_top_strategies">
            <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                Option Chain
                <i class="bx bx-chevron-down"></i>
            </button>

            <button class="btn btn-outline-primary">Future</button>
            <button class="btn btn-outline-primary">Saved Strategies</button>

            <i class="bi bi-arrow-clockwise"></i>
        </div>
    </div>
    <div class="collapse my-3" id="collapseExample">
        <div class="main_option_inner d-flex justify-content-between align-items-center">
            <p class="text-secondary">*Note: OI IN QUANTITY</p>
            <select id="optionExpiryDropdown" class="form-select w-auto">
                <!-- Options will be populated dynamically from AJAX response -->
            </select>
        </div>

        <div class="main_option_chain_table">
            <table class="table table-hover">
                <thead>
                    <th class="text-end bg-light-green">CALL IV</th>
                    <th class="text-end bg-light-green">CALL OI</th>
                    <th class="text-end bg-light-green">CALL LTP</th>
                    <th class="text-center bg-light">STRIKE PRICE</th>
                    <th class="text-start bg-light-red">PUT LTP</th>
                    <th class="text-start bg-light-red">PUT OI</th>
                    <th class="text-start bg-light-red">PUT IV</th>
                </thead>

                <tbody class="strategy_option_chain"></tbody>
            </table>
        </div>
    </div>
</div>
<div class="All_option_startegies_builder shadow">
    <div class="pre_built_simu">
        <p style="margin-bottom: auto">Pre Built :</p>
        <div class="strategy_simu">
            <div class="straddle" id="straddle">
                STRADDLE
            </div>
            <div class="straddle" id="strangle">
                STRANGLE
            </div>
            <div class="straddle" id="spread">
                SPREAD
            </div>
            <div class="straddle" id="iron_fly">
                IRON FLY
            </div>
            <div class="straddle" id="iron_condor">
                IRON CONDOR
            </div>
            <div class="straddle" id="jaze_lizard">
                JAZE LIZARD
            </div>
        </div>
    </div>
</div>

<div class="Option_startegies_data_display shadow py-3">
    <div class="display_table p-3">
        <div class="main_add_table d-flex justify-content-between my-1">
            <div class="empty_left"></div>

            <i class="add-btn bi bi-plus-square-fill"></i>
        </div>
        <style>
            .textOnInput {
                position: relative;
                width: 11rem;
            }

            .textOnInput label {
                position: absolute;
                top: -9px;
                font-weight: 700;
                left: 10px;
                padding: 2px;
                color: rgb(56, 56, 56);
                z-index: 1;
                font-size: 12px;
                white-space: nowrap;
            }

            .textOnInput label:after {
                content: " ";
                background-color: #fff;
                width: 100%;
                height: 13px;
                position: absolute;
                left: 0;
                bottom: 0;
                z-index: -1;
            }

            label {
                font-size: 16px;
                font-weight: 500;
                display: inline-block;
                margin-bottom: 0.5rem;
            }

            .form-control {
                box-shadow: none !important;
            }

            .data-display-table {
                display: flex;
                justify-content: center;
                flex-direction: column;
            }

            .put_call_btns:hover {
                background-color: white !important;
                color: #4399eb !important;
            }

            .put_max_profit {
                font-weight: 600;
                font-size: 13px !important;
                color: #21d052 !important;
            }

            .long_max_loss,
            .breakever_probaility_profit {
                font-weight: 600;
                font-size: 13px !important;
            }

            .strategy_cost_table,
            .greek_table {
                padding: 6px 0;
                cursor: pointer;
                font-family: system-ui;
                color: #000000b3;
                font-weight: 600;
            }

            #resultTable thead tr th,
            .PL-table thead tr th {
                color: #000000ad;
                font-size: 13px;
            }

            #resultTable tbody tr td,
            .PL-table tbody tr td {
                color: #000000ad !important;
                font-size: 12px !important;
                font-weight: 600 !important;
            }
        </style>
        <table class="data-display-table">
            <!-- Initial empty row -->
            <tr class="strategy_table_input">
                <td>
                    <div class="textOnInput">
                        <label for="optionSide">Instruments</label>
                        <select class="option_side_input form-select">
                            <option value="Select">Select</option>
                            <option value="">Long</option>
                            <option value="">Put</option>
                            <option value="">Future</option>
                        </select>
                    </div>
                </td>
                <td>
                    <div class="textOnInput">
                        <label for="expiryDate">Expiry Date</label>
                        <select class="expiry_date_input form-select">
                            <option value="Select">Select</option>
                        </select>
                    </div>
                </td>
                <td>
                    <div class="textOnInput">
                        <label for="strikePrice">Strike Price</label>
                        <select class="strike_price_input form-select">
                            <option value="Select">Select</option>
                        </select>
                    </div>
                </td>
                <td>
                    <div class="textOnInput">
                        <label for="action">Position</label>
                        <select class="action_input form-select">
                            <option value="Select">Select</option>
                            <option value="Short">Short</option>
                            <option value="Long">Long</option>
                        </select>
                    </div>
                </td>
                <td>
                    <div class="textOnInput">
                        <label for="action">No. of Lots</label>
                        <input type="number" class="option_lot_size_input form-control" value="1" />
                    </div>
                </td>
                <td>
                    <div class="textOnInput">
                        <label for="action">Traded Price</label>
                        <input type="number" class="ltpValue_input form-control" value="0" />
                    </div>
                </td>
                <td>
                    <i class="delete-btn bi bi-trash-fill"></i>
                </td>
            </tr>
        </table>

        <div class="save_calculates_button d-flex justify-content-between my-3">
            <div class="right_calc_empty"></div>
            <div class="calc_save_btns d-flex gap-1">
                <button class="btn btn-outline-primary" id="save">SAVE</button><button class="btn btn-outline-primary"
                    id="calculate">
                    CALCULATE
                </button>
            </div>
        </div>
    </div>
</div>
<style>
    .inner_greek_p_l {
        padding: 0px 6px;
    }

    .strategy_cost_table,
    .greek_table {
        padding: 6px 0;
        cursor: pointer;
    }

    .inner_greek_p_l {
        margin-bottom: 0.5rem;
    }

    .greek_strategy_active {
        color: #2196f3 !important;
        border-bottom: 3px solid #2196f3 !important;
    }
</style>
<div class="table_pl_greek shadow p-2 mt-3">
    <div class="main_filter_greek_P_L">
        <div class="inner_greek_p_l d-flex bg-light" style="gap: 1rem">
            <p class="strategy_cost_table greek_strategy_active">STRATEGY COST</p>
            <p class="greek_table">GREEKS</p>
        </div>
    </div>
    <div id="table-Greeks" class="table-responsive">
        <table id="resultTable" class="table table-hover ">
            <thead class="bg-light">
                <tr>
                    <th>LEG</th>
                    <th>POSITION</th>
                    <th>IV</th>
                    <th>DELTA</th>
                    <th>THETA</th>
                    <th>GAMMA</th>
                    <th>VEGA</th>
                    <th>RHO</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div id="table-PL_main" class="table-responsive">
        <table class="PL-table table table-hover ">
            <thead class="bg-light">
                <tr>
                    <th>LEG</th>
                    <th>POSITION</th>
                    <th>TRADED PRICE</th>
                    <th>CURRENT PRICE</th>
                    <th>LOTS</th>
                    <th>QTY.</th>
                    <th>TOTAL CUR. COST</th>
                    <th class="text-center">P/L</th>
                </tr>
            </thead>
            <tbody id="table-PL"></tbody>
        </table>
    </div>
</div>
<script>
    $(document).ready(function () {

        loadStocks();
        loadSpotData("NIFTY");
        loadExpiryData("NIFTY");
        setTimeout(function () {
            loadOptionData("NIFTY", "");
        }, 1000);
        $("#table-PL_main").show();
        $("#resultTable").hide();

        $(".strategy_cost_table").click(function () {
            $("#table-PL_main").show();
            $("#resultTable").hide();
            $(this).addClass("greek_strategy_active");
            $(".greek_table").removeClass("greek_strategy_active");
        });
        $(".greek_table").click(function () {
            $("#table-PL_main").hide();
            $("#resultTable").show();
            $(this).addClass("greek_strategy_active");
            $(".strategy_cost_table").removeClass("greek_strategy_active");
        });

        // After adding data row
        // Function to update empty message visibility based on data rows
        function updateEmptyMessageVisibility() {
            var numRows = $(".data-display-table tr.data-row").length;
            if (numRows === 0) {
                $(".empty_message").show();
            } else {
                $(".empty_message").hide();
            }
        }

        // After removing a data row, update the empty message visibility
        updateEmptyMessageVisibility();

        // Load spot data for "NIFTY" initially


        $("#calculate").click(function () {
            var selectedOption = $("#stockDropdown").val();
            console.log("ca=" + selectedOption);
            loadExpiryData(selectedOption)
            $("#table-PL").empty();
            $("#resultTable tbody").empty();

            var dataRows = $(".data-display-table").find("tr");
            var allData = [];
            var conditionOrder = 1;

            dataRows.each(function () {
                var row = $(this);
                var optionSide = row.find(".option_side_input").val();
                var expiryDate = row.find(".expiry_date_input").val();
                var strikePrice = row.find(".strike_price_input").val();
                var action = row.find(".action_input").val();
                var quantity = row.find(".option_lot_size_input").val();
                var ltpValue = row.find(".ltpValue_input").val();
                var option_lot_size = $("#lot_size_value").text();
                var main_conditionOrder = conditionOrder++;

                // Check if any field is empty
                if (
                    optionSide === "Select" ||
                    expiryDate === "Select" ||
                    strikePrice === "Select" ||
                    action === "Select" ||
                    quantity === "" ||
                    ltpValue === ""
                ) {
                    // Display a Bootstrap alert
                    alert("Please fill in all fields.");
                    return false; // Stop processing further rows
                } else {
                    // Convert quantity to negative if action is "Short"
                    // if (action === "Short") {
                    //     quantity = -Math.abs(quantity);
                    // }

                    // Collect data for this row
                    allData.push({
                        selectedOption: selectedOption,
                        optionSide: optionSide,
                        option_lot_size: option_lot_size,
                        expiryDate: expiryDate,
                        strikePrice: strikePrice,
                        action: action,
                        quantity: parseInt(quantity),
                        conditionOrder: main_conditionOrder,
                        ltpValue: ltpValue,
                    });
                }
                if (allData.length === dataRows.length) {
                    $.ajax({
                        type: "POST",
                        url: "/filter_iv_data",
                        data: JSON.stringify(allData),
                        contentType: "application/json",
                        success: function (response) {
                            console.log("Data sent to Django:", response);
                            console.log(response.stock_data.resultData);

                            // Clear previous table data
                            $("#resultTable tbody").empty();

                            // Process response data and populate the table
                            const resultData = response.iv_data.resultData;
                            let totalDelta = 0;
                            let totalTheta = 0;
                            let totalGamma = 0;
                            let totalVega = 0;
                            let totalRho = 0;
                            let leg = 1;

                            for (const item of resultData) {
                                const optionType = item.optiontype;
                                const symbol = item.symbol;
                                const strikePrice = item.strikeprice;
                                const expiry = item.expiry;
                                const position = item.position;
                                const iv = item.calls_iv || item.puts_iv;
                                const delta =
                                    optionType === "Call" ? item.call_delta : item.put_delta;
                                const theta =
                                    optionType === "Call" ? item.call_theta : item.put_theta;
                                const gamma =
                                    optionType === "Call" ? item.call_gamma : item.put_gamma;
                                const vega =
                                    optionType === "Call" ? item.call_vega : item.put_vega;
                                const rho =
                                    optionType === "Call" ? item.call_rho : item.put_rho;

                                // Create the table row for each option
                                const tableRow = `
                                        <tr>
                                            <td>LEG${leg++}</td>
                                            <td>${position.toUpperCase()} ${strikePrice}${optionType.toUpperCase()}(${expiry})</td>
                                        
                                            <td>${iv !== null ? iv.toFixed(2) : 0}</td>
                                            <td>${delta !== null ? delta.toFixed(2) : 0}</td>
                                            <td>${theta !== null ? theta.toFixed(4) : 0}</td>
                                            <td>${gamma !== null ? gamma.toFixed(4) : 0}</td>
                                            <td>${vega !== null ? vega.toFixed(2) : 0}</td>
                                            <td>${rho !== null ? rho.toFixed(2) : 0}</td>
                                        </tr>
                

                        `;

                                $("#resultTable tbody").append(tableRow);

                                // Calculate positional Greeks
                                totalDelta += parseFloat(delta);
                                totalTheta += parseFloat(theta);
                                totalGamma += parseFloat(gamma);
                                totalVega += parseFloat(vega);
                                totalRho += parseFloat(rho);
                            }

                            // Add the row for positional Greeks
                            const totalRow = `
              <tr>
                  <td>POSITIONAL GREEKS</td>
                  <td></td>
                  <td></td>
                  <td>${totalDelta !== null ? totalDelta.toFixed(2) : 0}</td>
                  <td>${totalTheta !== null ? totalTheta.toFixed(4) : 0}</td>
                  <td>${totalGamma !== null ? totalGamma.toFixed(4) : 0}</td>
                  <td>${totalVega !== null ? totalVega.toFixed(2) : 0}</td>
                  <td>${totalRho !== null ? totalRho.toFixed(2) : 0}</td>
              </tr>
          `;


                            $("#resultTable tbody").append(totalRow);

                            // Assuming response.stock_data.resultData is an array containing the data
                            const updatedResultData = response.stock_data.resultData.map(
                                (item, index) => {
                                    const ltpValue = $(".strategy_table_input")
                                        .eq(index)
                                        .find(".ltpValue_input")
                                        .val();

                                    return { ...item, ltpValue: parseFloat(ltpValue) };
                                }
                            );
                            console.log(updatedResultData);
                            function createTable(data) {
                                let tableHTML = "";

                                let netCost = 0;
                                let netPL = 0;

                                let shortCount = 0;
                                let longCount = 0;

                                // Loop through the data to count short and long positions
                                for (const item of data) {
                                    const shortMatches = item.position.match(/Short/gi);
                                    const longMatches = item.position.match(/Long/gi);

                                    if (shortMatches) {
                                        shortCount += shortMatches.length;
                                    }

                                    if (longMatches) {
                                        longCount += longMatches.length;
                                    }
                                }
                                let maxStrikePrice = Number.NEGATIVE_INFINITY;
                                let minStrikePrice = Number.POSITIVE_INFINITY;
                                // Determine the position label based on the majority
                                const positionLabel = shortCount > longCount ? "SHORT" : "LONG";
                                let totalStrikePrice = 0;
                                let itemCount = 0;
                                let premiumPain = 0;
                                for (let i = 0; i < data.length; i++) {
                                    const item = data[i];

                                    // Adjust lotSize based on position
                                    const adjustedLotSize =
                                        item.position.toLowerCase() === "short"
                                            ? -item.lotSize
                                            : item.lotSize;
                                    const absoluteQuantity = Math.abs(item.quantity);
                                    const totalCurrentCost =
                                        item.unitPrice * adjustedLotSize * absoluteQuantity;
                                    const totalPL =
                                        item.ltpValue * adjustedLotSize * absoluteQuantity;
                                    var final_P_L = totalPL - totalCurrentCost;

                                    maxStrikePrice = Math.max(maxStrikePrice, item.strikePrice);
                                    minStrikePrice = Math.min(minStrikePrice, item.strikePrice);

                                    const legRow = `
                                                                <tr>
                                                                    <td>LEG ${i + 1
                                        }</td>
                                                                    <td>${item.position.toUpperCase()} ${item.strikePrice
                                        }${item.optionType.toUpperCase()}(${item.expiry})</td>
                                                                    <td>${item.ltpValue
                                        }</td>
                                                                    <td>${item.unitPrice
                                        }</td>
                                                                    <td>${adjustedLotSize}</td>
                                                                    <td>${absoluteQuantity}</td>
                                                                    <td>${totalCurrentCost}</td>
                                                                    <td class="text-center">${final_P_L}</td>
                                                                </tr>
                                                            `;
                                    tableHTML += legRow;
                                    netCost += parseFloat(totalCurrentCost);
                                    netPL += parseFloat(final_P_L);
                                    totalStrikePrice += parseFloat(item.strikePrice);
                                    itemCount++;
                                    premiumPain += parseFloat(item.unitPrice)

                                }
                                console.log(totalStrikePrice);
                                const averageStrikePrice = totalStrikePrice / itemCount;
                                console.log("Average of the :" + averageStrikePrice);
                                console.log(positionLabel);
                                var min_breakPoints = averageStrikePrice - premiumPain
                                var max_breakPoints = averageStrikePrice + premiumPain



                                var Put_position_label =
                                    positionLabel == "SHORT"
                                        ? Math.abs(netCost + -netPL)
                                        : "Unlimited";
                                var long_position_label =
                                    positionLabel == "LONG"
                                        ? Math.abs(netCost + -netPL)
                                        : "Unlimited";
                                var Put_position_display =
                                    positionLabel == "SHORT" ? "d-block" : "d-none";
                                var long_position_display =
                                    positionLabel == "LONG" ? "d-block" : "d-none";

                                tableHTML += `
                                                                <tr>
                                                                    <td colspan="6">NET COST OF STRATEGY :</td>
                                                                    <td>${netCost}</td>
                                                                    <td colspan="7" class="text-center">${netPL}</td>
                                                                
                                                                </tr>
                                                                <tr>
                                                                    <td colspan="1">
                                                                        <div class="put_max_profit d-block text-success fw-600">
                                                                            <p>Max - Profit: ${Put_position_label}</p>
                                                                            <p class=${Put_position_display}>At: ${minStrikePrice}~${maxStrikePrice}</p>
                                                                            </div>
                                                                        </td>
                                                                        <td clospan="3">
                                                                            <div class="long_max_loss d-block text-danger fw-600">
                                                                            <p>Max - Profit: ${long_position_label}</p>
                                                                            <p class=${long_position_display}>At: ${minStrikePrice}~${maxStrikePrice}</p>
                                                                            </div>
                                                                            </td>
                                                                            <td colspan="5" class="fw-600">Reward Risk: Not defined</td>

                                                                            <td clospan="7" class="fw-600 text-center">
                                                                                
                                                                                <div class="breakever_probaility_profit">
                                                                                    
                                                                                    <p>Min Breakeven : ${min_breakPoints.toFixed(2)} ~ Max Breakeven : ${max_breakPoints.toFixed(2)}</p>
                                                                                    <p>Probability of Profit: 10.00%</p>
                                                                                    </div>
                                                                                </td>

                                                                    </tr>
                                                            `;

                                return tableHTML;
                            }

                            const tableBody = document.getElementById("table-PL");
                            tableBody.innerHTML = createTable(updatedResultData);
                        },

                        error: function (xhr, status, error) {
                            console.error("Error sending data to Django:", error);
                        },
                    });
                }
            });

            // If all data is valid, log all the data at once
            if (allData.length === dataRows.length) {
                console.log("All Data:", allData);
            }
        });

        var isFirstTime = true;
        $("#collapseExample").on("show.bs.collapse", function () {
            $(".bx-chevron-down")
                .removeClass("bx-chevron-down")
                .addClass("bx-chevron-up");
        });

        $("#collapseExample").on("hide.bs.collapse", function () {
            $(".bx-chevron-up")
                .removeClass("bx-chevron-up")
                .addClass("bx-chevron-down");
        });


        // Handle stock dropdown change
        $("#stockDropdown").change(function () {
            var selectedOption = $(this).val();

            $(".data-display-table").empty();
            $("#table-PL").empty();
            $("#resultTable tbody").empty();
            if (selectedOption) {
                loadSpotData(selectedOption);

                setTimeout(function () {
                    loadOptionData(selectedOption, "");
                }, 1000);

            }
        });

        // Function to load spot data
        function loadSpotData(selectedOption) {
            console.log(selectedOption);

            $.ajax({
                url:
                    '{% url "get_option_strategy_optimizer_spot_data" %}?selected_option=' +
                    selectedOption,
                type: "GET",
                success: function (response) {
                    // Handle the response as needed
                    console.log(response.spot_data.resultData);
                    $("#max_pain_value").text(response.spot_data.resultData.max_pain);
                    $("#lot_size_value").text(response.spot_data.resultData.lot_size);
                    var spot_check_strategies = response.spot_data.resultData.change_per;
                    var valid_spot_value_strategies =
                        spot_check_strategies > 0 ? "text-success" : "text-danger";
                    var arrow_valid = spot_check_strategies > 0 ? "up" : "down";
                    $("#spot_value").empty().append(`
                        <div class="${valid_spot_value_strategies} d-flex align-items-center gap-1">
                            <p class="last_traded_price">${response.spot_data.resultData.last_trade_price}</p>
                            <i class='bx bxs-${arrow_valid}-arrow' id="spot_arrow"></i>
                            <p>${response.spot_data.resultData.change_value}(${response.spot_data.resultData.change_per})</p>
                            
                            </div>
                        `);
                },
            });
        }

        $("#optionExpiryDropdown").change(function () {
            var selectedOption = $("#stockDropdown").val();
            var selectedExpiry = $("#optionExpiryDropdown").val();
            var selectedOptionExpiry = $(this).val();
            $(".data-display-table").empty();
            $("#table-PL").empty();
            $("#resultTable tbody").empty();
            if (selectedOption) {
                loadOptionData(selectedOption, selectedOptionExpiry);
            }
        });

        function loadOptionData(selectedOption, selectedExpiry) {
            $.ajax({
                url:
                    '{% url "get_option_strategy_optimizer_option_data" %}?selected_option=' +
                    selectedOption +
                    "&selected_expiry=" +
                    selectedExpiry,
                type: "GET",
                success: function (response) {
                    console.log(response.option_data.resultData.opExpiryDates);
                    var optionExpiryDropdown = $("#optionExpiryDropdown");
                    optionExpiryDropdown.empty();
                    $.each(
                        response.option_data.resultData.opExpiryDates,
                        function (index, expiryDate) {
                            var option = $("<option>").text(expiryDate.split("T")[0]);
                            optionExpiryDropdown.append(option);
                        }
                    );
                    if (selectedExpiry) {
                        $("#optionExpiryDropdown").val(selectedExpiry);
                    }
                    var option_chain_data = response.option_data.resultData.opDatas;
                    console.log(option_chain_data[0]);
                    console.log($("#optionExpiryDropdown").val());
                    var option_expiry_date = $("#optionExpiryDropdown").val();
                    var lot_size_value_option = $("#lot_size_value").text();
                    console.log(lot_size_value_option);
                    console.log(selectedOption);

                    // console.log(selectedExpiry)

                    var optionChainTable = $(".strategy_option_chain");
                    optionChainTable.empty();


                    var spot_strike_price = $(".last_traded_price").text()

                    var closestStrikePrice = null;
                    var closestDiff = Number.MAX_VALUE;

                    $.each(
                        response.option_data.resultData.opDatas,
                        function (index, optionChain) {

                            var strike_price = parseFloat(optionChain.strike_price);
                            var diff = Math.abs(spot_strike_price - strike_price);

                            if (diff < closestDiff) {
                                closestDiff = diff;
                                closestStrikePrice = strike_price;
                            }
                            var rowContent = `
                                <tr class="call_put_tr">
                                    <td class="text-end">${optionChain.calls_iv}</td>
                                    <td class="text-end">${optionChain.calls_oi}</td>
                                    <td class="text-end call-ltp cursor-pointer  position-relative">
                                        <div class="d-flex position-absolute top-0 call-pul-ltp-btns d-none call-row">
                                            <button id="Auto_calls_short_click" title="Short" data-action="Short" data-side="call" type="button" class="px-lg-3 py-lg-1 mx-1 bg-light-green put_call_btns common-border shadow-none fs-13 fw-600 btn btn-primary">S</button>
                                            <button id="Auto_calls_long_click" title="Long" data-action="Long" data-side="call" type="button" class="px-lg-3 py-lg-1 mx-1 bg-light-red put_call_btns  shadow-none fs-13 fw-600 btn btn-primary">L</button>
                                            </div>
                                        <p class="calls_ltp">
                                        ${optionChain.calls_ltp} </p></td>
                                    <td class="text-center  bg-light">
                        <div class='strike_price'> 
                            ${optionChain.strike_price}
                            </div>
                                        
                                        <div class=d-none>
                                            
                                            <div class="expiry_date">${option_expiry_date}</div>
                                            <div class="opiton_lot_size">${lot_size_value_option}</div>
                                            <div class="opiton_selected">${selectedOption}</div>

                                                </div>
                                  
                                       
                                        </td>
                          
                                    <td class="text-start put-ltp cursor-pointer  position-relative">
                                        <p class="puts_ltp">${optionChain.puts_ltp}</p>
                                        <div class="d-flex position-absolute top-0 call-pul-ltp-btns  d-none" id="put_call_put">
                                            <button id="Auto_puts_short_click" title="Short" type="button" data-action="Short" data-side="put" class="px-lg-3 py-lg-1 mx-1 bg-light-green put_call_btns common-border shadow-none fs-13 fw-600 btn btn-primary">S</button>
                                            <button id="Auto_puts_long_click" title="Long" data-action="Long" data-side="put" type="button" class="px-lg-3 bg-light-red put_call_btns py-lg-1 mx-1  shadow-none fs-13 fw-600 btn btn-primary">L</button>
                                            </div>
                                        </td>
                                    <td class="text-start">${optionChain.puts_oi}</td>
                                    <td class="text-start">${optionChain.puts_iv}</td>
                                </tr>
                            `;

                            optionChainTable.append(rowContent);

                        }
                    );
                    console.log("Nearest Strike Price:", closestStrikePrice);

                    function selectStrategy(filter_arg_strategy) {
                        $(".data-display-table").empty();
                        $("#table-PL").empty();
                        $("#resultTable tbody").empty();
                        if (filter_arg_strategy === "straddle") {
                            $("#straddle").addClass("option_strategies_active")
                            $("#strangle").removeClass("option_strategies_active")
                            $("#iron_fly").removeClass("option_strategies_active")
                            $("#spread").removeClass("option_strategies_active")
                            $("#iron_condor").removeClass("option_strategies_active")
                            $("#jaze_lizard").removeClass("option_strategies_active")
                            $(".data-display-table").empty();
                            $("#table-PL").empty();
                            $("#resultTable tbody").empty();
                            optionChainTable.find(".strike_price").each(function () {
                                var rowStrikePrice = parseFloat($(this).text());
                                if (rowStrikePrice === closestStrikePrice) {
                                    setTimeout(function () {
                                        $(this).closest(".call_put_tr")
                                            .find("#Auto_calls_short_click, #Auto_puts_short_click")
                                            .click();
                                        $("#calculate").click();
                                    }.bind(this), 200); // Delay of 100ms
                                }
                            });
                        }
                        else if (filter_arg_strategy === 'strangle') {
                            $("#straddle").removeClass("option_strategies_active")
                            $("#strangle").addClass("option_strategies_active")
                            $("#iron_fly").removeClass("option_strategies_active")
                            $("#spread").removeClass("option_strategies_active")
                            $("#iron_condor").removeClass("option_strategies_active")
                            $("#jaze_lizard").removeClass("option_strategies_active")
                            $(".data-display-table").empty();
                            $("#table-PL").empty();
                            $("#resultTable tbody").empty();

                            // Ensure you are selecting the correct elements with .strike_price
                            var strikePrices = optionChainTable.find(".strike_price").map(function () {
                                return parseFloat($(this).text());
                            }).get();

                            // Find the index of the row where strikePrice is closestStrikePrice
                            var currentIndex = strikePrices.indexOf(closestStrikePrice);

                            // Calculate the previous 5 strike prices
                            var prev5 = [];
                            for (var i = currentIndex - 1; i >= 0 && prev5.length < 5; i--) {
                                var rowStrikePrice = strikePrices[i];
                                if (!isNaN(rowStrikePrice)) {
                                    prev5.push(rowStrikePrice);
                                }
                            }

                            // Calculate the next 5 strike prices
                            var forw5 = [];
                            for (var j = currentIndex + 1; j < strikePrices.length && forw5.length < 5; j++) {
                                var rowStrikePrice = strikePrices[j];
                                if (!isNaN(rowStrikePrice)) {
                                    forw5.push(rowStrikePrice);
                                }
                            }

                            console.log("Previous 5 Strike Prices:", prev5);
                            console.log("Next 5 Strike Prices:", forw5);

                            if (prev5.length === 5 && forw5.length === 5) {
                                // Get the values of lastIndexPrev and lastIndexForw
                                var lastIndexPrev = prev5[prev5.length - 1];
                                var lastIndexForw = forw5[forw5.length - 1];

                                // Find the closest row for lastIndexPrev and click on Auto_puts_short_click
                                var closestRowPrev = optionChainTable.find(".strike_price:contains(" + lastIndexPrev + ")").closest(".call_put_tr");
                                if (closestRowPrev.length) {
                                    setTimeout(function () {
                                        closestRowPrev.find("#Auto_puts_short_click").click();
                                    }.bind(this),);
                                }

                                // Find the closest row for lastIndexForw and click on Auto_calls_short_click
                                var closestRowForw = optionChainTable.find(".strike_price:contains(" + lastIndexForw + ")").closest(".call_put_tr");
                                if (closestRowForw.length) {
                                    setTimeout(function () {
                                        closestRowForw.find("#Auto_calls_short_click").click();
                                    }.bind(this), 500); // Adjust the delay as needed
                                }

                                // Click on #calculate after a longer delay
                                setTimeout(function () {
                                    $("#calculate").click();
                                }, 1000); // Adjust the delay as needed
                            }
                        }



                        else if (filter_arg_strategy === 'spread') {
                            $("#straddle").removeClass("option_strategies_active")
                            $("#strangle").removeClass("option_strategies_active")
                            $("#iron_fly").removeClass("option_strategies_active")
                            $("#spread").addClass("option_strategies_active")
                            $("#iron_condor").removeClass("option_strategies_active")
                            $("#jaze_lizard").removeClass("option_strategies_active")
                            $(".data-display-table").empty();
                            $("#table-PL").empty();
                            $("#resultTable tbody").empty();

                            optionChainTable.find(".strike_price").each(function () {
                                var rowStrikePrice = parseFloat($(this).text());
                                if (rowStrikePrice === closestStrikePrice) {
                                    setTimeout(function () {
                                        $(this).closest(".call_put_tr")
                                            .find("#Auto_calls_short_click")
                                            .click();
                                        $("#calculate").click();
                                    }.bind(this), 200); // Delay of 100ms
                                }
                            });

                            // Ensure you are selecting the correct elements with .strike_price
                            var strikePrices = optionChainTable.find(".strike_price").map(function () {
                                return parseFloat($(this).text());
                            }).get();

                            // Find the index of the row where strikePrice is closestStrikePrice
                            var currentIndex = strikePrices.indexOf(closestStrikePrice);

                            // Calculate the next 5 strike prices
                            var forw3 = [];
                            for (var j = currentIndex + 1; j < strikePrices.length && forw3.length < 3; j++) {
                                var rowStrikePrice = strikePrices[j];
                                if (!isNaN(rowStrikePrice)) {
                                    forw3.push(rowStrikePrice);
                                }
                            }

                            if (forw3.length === 3) {
                                // Get the values of lastIndexPrev and lastIndexForw

                                var lastIndexForw = forw3[forw3.length - 1];

                                // Find the closest row for lastIndexPrev and click on Auto_puts_short_click
                                var closestRowPrev = optionChainTable.find(".strike_price:contains(" + lastIndexPrev + ")").closest(".call_put_tr");
                                if (closestRowPrev.length) {
                                    setTimeout(function () {
                                        closestRowPrev.find("#Auto_puts_short_click").click();
                                    }.bind(this),);
                                }

                                // Find the closest row for lastIndexForw and click on Auto_calls_short_click
                                var closestRowForw = optionChainTable.find(".strike_price:contains(" + lastIndexForw + ")").closest(".call_put_tr");
                                if (closestRowForw.length) {
                                    setTimeout(function () {
                                        closestRowForw.find("#Auto_calls_long_click").click();
                                    }.bind(this), 300); // Adjust the delay as needed
                                }

                                // Click on #calculate after a longer delay
                                setTimeout(function () {
                                    $("#calculate").click();
                                }, 1000); // Adjust the delay as needed
                            }






                        }


                        else if (filter_arg_strategy === 'iron_fly') {
                            $("#straddle").removeClass("option_strategies_active")
                            $("#strangle").removeClass("option_strategies_active")
                            $("#iron_fly").addClass("option_strategies_active")
                            $("#spread").removeClass("option_strategies_active")
                            $("#iron_condor").removeClass("option_strategies_active")
                            $("#jaze_lizard").removeClass("option_strategies_active")
                            $(".data-display-table").empty();
                            $("#table-PL").empty();
                            $("#resultTable tbody").empty();

                            // Ensure you are selecting the correct elements with .strike_price
                            var strikePrices = optionChainTable.find(".strike_price").map(function () {
                                return parseFloat($(this).text());
                            }).get();

                            // Find the index of the row where strikePrice is closestStrikePrice
                            var currentIndex = strikePrices.indexOf(closestStrikePrice);

                            // Calculate the previous 4 and forward 4 strike prices
                            var prev4 = [];
                            var forw4 = [];

                            for (var i = currentIndex - 1; i >= 0 && prev4.length < 4; i--) {
                                var rowStrikePrice = strikePrices[i];
                                if (!isNaN(rowStrikePrice)) {
                                    prev4.push(rowStrikePrice);
                                }
                            }

                            for (var j = currentIndex + 1; j < strikePrices.length && forw4.length < 4; j++) {
                                var rowStrikePrice = strikePrices[j];
                                if (!isNaN(rowStrikePrice)) {
                                    forw4.push(rowStrikePrice);
                                }
                            }

                            console.log("Previous 4 Strike Prices:", prev4);
                            console.log("Next 4 Strike Prices:", forw4);

                            // Keep the existing logic for closestStrikePrice
                            optionChainTable.find(".strike_price").each(function () {
                                var rowStrikePrice = parseFloat($(this).text());
                                if (rowStrikePrice === closestStrikePrice) {
                                    setTimeout(function () {
                                        $(this).closest(".call_put_tr")
                                            .find("#Auto_calls_short_click, #Auto_puts_short_click")
                                            .click();
                                        $("#calculate").click();
                                    }.bind(this), 200); // Delay of 100ms
                                }
                            });

                            // Get the values of lastIndexPrev and lastIndexForw
                            var lastIndexPrev = prev4[prev4.length - 1];
                            var lastIndexForw = forw4[forw4.length - 1];

                            // Find the closest row for lastIndexPrev and click on Auto_puts_short_click
                            var closestRowPrev = optionChainTable.find(".strike_price:contains(" + lastIndexPrev + ")").closest(".call_put_tr");
                            if (closestRowPrev.length) {
                                setTimeout(function () {
                                    closestRowPrev.find("#Auto_puts_long_click").click();
                                }.bind(this), 100);
                            }

                            // Find the closest row for lastIndexForw and click on Auto_calls_short_click
                            var closestRowForw = optionChainTable.find(".strike_price:contains(" + lastIndexForw + ")").closest(".call_put_tr");
                            if (closestRowForw.length) {
                                setTimeout(function () {
                                    closestRowForw.find("#Auto_calls_long_click").click();
                                }.bind(this), 300); // Adjust the delay as needed
                            }

                            // Click on #calculate after a longer delay
                            setTimeout(function () {
                                $("#calculate").click();
                            }, 1000); // Adjust the delay as needed
                        }
                        else if (filter_arg_strategy === 'iron_condor') {
                            $("#straddle").removeClass("option_strategies_active")
                            $("#strangle").removeClass("option_strategies_active")
                            $("#iron_fly").removeClass("option_strategies_active")
                            $("#spread").removeClass("option_strategies_active")
                            $("#iron_condor").addClass("option_strategies_active")
                            $("#jaze_lizard").removeClass("option_strategies_active")
                            $(".data-display-table").empty();
                            $("#table-PL").empty();
                            $("#resultTable tbody").empty();

                            // Ensure you are selecting the correct elements with .strike_price
                            var strikePrices = optionChainTable.find(".strike_price").map(function () {
                                return parseFloat($(this).text());
                            }).get();

                            // Find the index of the row where strikePrice is closestStrikePrice
                            var currentIndex = strikePrices.indexOf(closestStrikePrice);

                            // Calculate the previous 4 and forward 4 strike prices
                            var prev4 = [];
                            var prev3 = [];
                            var forw3 = [];
                            var forw4 = [];

                            for (var i = currentIndex - 1; i >= 0 && (prev4.length < 4 || prev3.length < 3); i--) {
                                var rowStrikePrice = strikePrices[i];
                                if (!isNaN(rowStrikePrice)) {
                                    if (prev4.length < 4) {
                                        prev4.push(rowStrikePrice);
                                    }
                                    if (prev3.length < 3) {
                                        prev3.push(rowStrikePrice);
                                    }
                                }
                            }

                            for (var j = currentIndex + 1; j < strikePrices.length && (forw4.length < 4 || forw3.length < 3); j++) {
                                var rowStrikePrice = strikePrices[j];
                                if (!isNaN(rowStrikePrice)) {
                                    if (forw4.length < 4) {
                                        forw4.push(rowStrikePrice);
                                    }
                                    if (forw3.length < 3) {
                                        forw3.push(rowStrikePrice);
                                    }
                                }
                            }

                            console.log("Previous 3 Strike Prices:", prev3);
                            console.log("Previous 4 Strike Prices:", prev4);
                            console.log("Next 4 Strike Prices:", forw4);
                            console.log("Next 3 Strike Prices:", forw3);

                            // Get the values of lastIndexPrev and lastIndexForw
                            var lastIndexPrev = prev4[prev4.length - 1];
                            var lastIndexForw = forw4[forw4.length - 1];
                            var lastIndexPrev3 = prev3[prev3.length - 1];
                            var lastIndexForw3 = forw3[forw3.length - 1];

                            // Find the closest row for lastIndexPrev and click on Auto_puts_short_click


                            var closestRowPrev = optionChainTable.find(".strike_price:contains(" + lastIndexPrev + ")").closest(".call_put_tr");
                            if (closestRowPrev.length) {
                                setTimeout(function () {
                                    closestRowPrev.find("#Auto_puts_long_click").click();
                                }.bind(this), 100);
                            }
                            var closestRowPrev3 = optionChainTable.find(".strike_price:contains(" + lastIndexPrev3 + ")").closest(".call_put_tr");
                            if (closestRowPrev3.length) {
                                setTimeout(function () {
                                    closestRowPrev3.find("#Auto_puts_short_click").click();
                                }.bind(this), 200);
                            }
                            // Find the closest row for lastIndexForw and click on Auto_calls_short_click
                            var closestRowForw3 = optionChainTable.find(".strike_price:contains(" + lastIndexForw3 + ")").closest(".call_put_tr");
                            if (closestRowForw3.length) {
                                setTimeout(function () {
                                    closestRowForw3.find("#Auto_calls_short_click").click();
                                }.bind(this), 300); // Adjust the delay as needed
                            }


                            var closestRowForw = optionChainTable.find(".strike_price:contains(" + lastIndexForw + ")").closest(".call_put_tr");
                            if (closestRowForw.length) {
                                setTimeout(function () {
                                    closestRowForw.find("#Auto_calls_long_click").click();
                                }.bind(this), 400); // Adjust the delay as needed
                            }

                            // Click on #calculate after a longer delay
                            setTimeout(function () {
                                $("#calculate").click();
                            }, 1000); // Adjust the delay as needed
                        }


                        else if (filter_arg_strategy === 'jaze_lizard') {
                            $("#straddle").removeClass("option_strategies_active")
                            $("#strangle").removeClass("option_strategies_active")
                            $("#iron_fly").removeClass("option_strategies_active")
                            $("#spread").removeClass("option_strategies_active")
                            $("#iron_condor").removeClass("option_strategies_active")
                            $("#jaze_lizard").addClass("option_strategies_active")
                            $(".data-display-table").empty();
                            $("#table-PL").empty();
                            $("#resultTable tbody").empty();


                            // Ensure you are selecting the correct elements with .strike_price
                            var strikePrices = optionChainTable.find(".strike_price").map(function () {
                                return parseFloat($(this).text());
                            }).get();

                            // Find the index of the row where strikePrice is closestStrikePrice
                            var currentIndex = strikePrices.indexOf(closestStrikePrice);

                            // Calculate the previous 4 and forward 4 strike prices
                            var prev4 = [];

                            var forw2 = [];
                            var forw4 = [];

                            for (var i = currentIndex - 1; i >= 0 && (prev4.length < 4); i--) {
                                var rowStrikePrice = strikePrices[i];
                                if (!isNaN(rowStrikePrice)) {
                                    if (prev4.length < 4) {
                                        prev4.push(rowStrikePrice);
                                    }

                                }
                            }

                            for (var j = currentIndex + 1; j < strikePrices.length && (forw4.length < 4 || forw2.length < 2); j++) {
                                var rowStrikePrice = strikePrices[j];
                                if (!isNaN(rowStrikePrice)) {
                                    if (forw4.length < 4) {
                                        forw4.push(rowStrikePrice);
                                    }
                                    if (forw2.length < 2) {
                                        forw2.push(rowStrikePrice);
                                    }
                                }
                            }


                            console.log("Previous 4 Strike Prices:", prev4);
                            console.log("Next 4 Strike Prices:", forw4);
                            console.log("Next 2 Strike Prices:", forw2);

                            // Get the values of lastIndexPrev and lastIndexForw
                            var lastIndexPrev = prev4[prev4.length - 1];
                            var lastIndexForw = forw4[forw4.length - 1];

                            var lastIndexForw2 = forw2[forw2.length - 1];

                            // Find the closest row for lastIndexPrev and click on Auto_puts_short_click


                            var closestRowPrev = optionChainTable.find(".strike_price:contains(" + lastIndexPrev + ")").closest(".call_put_tr");
                            if (closestRowPrev.length) {
                                setTimeout(function () {
                                    closestRowPrev.find("#Auto_puts_short_click").click();
                                }.bind(this), 100);
                            }

                            // Find the closest row for lastIndexForw and click on Auto_calls_short_click
                            var closestRowForw2 = optionChainTable.find(".strike_price:contains(" + lastIndexForw2 + ")").closest(".call_put_tr");
                            if (closestRowForw2.length) {
                                setTimeout(function () {
                                    closestRowForw2.find("#Auto_calls_short_click").click();
                                }.bind(this), 200); // Adjust the delay as needed
                            }


                            var closestRowForw = optionChainTable.find(".strike_price:contains(" + lastIndexForw + ")").closest(".call_put_tr");
                            if (closestRowForw.length) {
                                setTimeout(function () {
                                    closestRowForw.find("#Auto_calls_long_click").click();
                                }.bind(this), 300); // Adjust the delay as needed
                            }

                            // Click on #calculate after a longer delay
                            setTimeout(function () {
                                $("#calculate").click();
                            }, 1000); // Adjust the delay as needed






                        }

                    }

                    // Common function to handle strategy button click
                    function attachButtonClickEvent($button, strategy) {
                        $button.off("click").on("click", function () {
                            $(".data-display-table").empty();
                            $("#table-PL").empty();
                            $("#resultTable tbody").empty();
                            selectStrategy(strategy);
                        });
                    }


                    // Attach click event handlers to strategy buttons
                    attachButtonClickEvent($("#straddle"), "straddle");
                    attachButtonClickEvent($("#strangle"), "strangle");
                    attachButtonClickEvent($("#iron_fly"), "iron_fly");
                    attachButtonClickEvent($("#spread"), "spread");
                    attachButtonClickEvent($("#iron_condor"), "iron_condor");
                    attachButtonClickEvent($("#jaze_lizard"), "jaze_lizard");





                    var isTableEmpty = true;

                    $(".put_call_btns").click(function () {

                        if (isTableEmpty) {
                            $(".data-display-table").empty();
                            isTableEmpty = false;
                        }
                        var row = $(this).closest("tr"); // Find the closest table row
                        var action = $(this).attr("data-action"); // Get the action (Short/Long) from the button's data attribute
                        var side = $(this).attr("data-side"); // Get the side (Call/Put) from the button's data attribute

                        var ltpValue =
                            side === "call"
                                ? row.find(".calls_ltp").text()
                                : row.find(".puts_ltp").text();

                        // Now you can access the data from the row and log it as needed
                        if (side === "call") {
                            var calls_iv = row.find(".text-end").eq(0).text();
                            var calls_oi = row.find(".text-end").eq(1).text();
                            var expiry_date = row.find(".expiry_date").text();
                            var strike_price = row.find(".strike_price").text();
                            var opiton_lot_size = row.find(".opiton_lot_size").text();
                            var opiton_selected = row.find(".opiton_selected").text();
                            var option_side = "Call";

                            // console.log(option_side);
                            // console.log("Call Side - Action:", action);
                            // console.log("Call Side - calls_iv:", calls_iv);
                            // console.log("Call Side - calls_oi:", calls_oi);
                            // console.log("Call Side - calls_ltp:", ltpValue);
                            // console.log("Call Side - strike_price:", strike_price);
                            // console.log(expiry_date);
                            // console.log(opiton_lot_size);
                            populateInputTable(
                                option_side,
                                expiry_date,
                                strike_price,
                                action,
                                opiton_lot_size,
                                ltpValue,
                                opiton_selected
                            );
                        } else {
                            var option_side = "Put";
                            var puts_oi = row.find(".text-start").eq(1).text();
                            var puts_iv = row.find(".text-start").eq(2).text();
                            var expiry_date = row.find(".expiry_date").text();
                            var strike_price = row.find(".strike_price").text();
                            var opiton_lot_size = row.find(".opiton_lot_size").text();
                            var opiton_selected = row.find(".opiton_selected").text();
                            // console.log(option_side);
                            // console.log("Put Side - Action:", action);
                            // console.log("Put Side - puts_ltp:", ltpValue);
                            // console.log("Put Side - puts_oi:", puts_oi);
                            // console.log("Put Side - puts_iv:", puts_iv);
                            // console.log(expiry_date);
                            // console.log(opiton_lot_size);
                            // console.log(strike_price);
                            populateInputTable(
                                option_side,
                                expiry_date,
                                strike_price,
                                action,
                                opiton_lot_size,
                                ltpValue,
                                opiton_selected
                            );
                        }
                    });






                    $(".add-btn").off("click");
                    $(".add-btn").click(function (event) {
                        event.preventDefault(); // Prevent default behavior

                        var selectedOption = $("#stockDropdown").val();
                        loadExpiryData(selectedOption);

                        var newRow = $("<tr>").addClass("strategy_table_input");

                        newRow.append(
                            $("<td>").html(`
                <div class="textOnInput">
                    <label for="optionSide">Option Side</label>
                    <select class="option_side_input form-select">
                        <option value="Select">Select</option>
                        <option value="Call">Call</option>
                        <option value="Put">Put</option>
                        <option value="Future">Future</option>
                    </select>
                </div>
            `)
                        );

                        newRow.append(
                            $("<td>").html(`
                <div class="textOnInput">
                    <label for="expiryDate">Expiry Date</label>
                    <select class="expiry_date_input form-select">
                        <option value="Select">Select</option>
                        <option value=""></option>
                    </select>
                </div>
            `)
                        );

                        newRow.append(
                            $("<td>").html(`
                <div class="textOnInput">
                    <label for="strikePrice">Strike Price</label>
                    <select class="strike_price_input form-select">
                        <option value="Select">Select</option>
                        <option value=""></option>
                    </select>
                </div>
            `)
                        );

                        newRow.append(
                            $("<td>").html(`
                <div class="textOnInput">
                    <label for="action">Position</label>
                    <select class="action_input form-select">
                        <option value="Select">Select</option>
                        <option value="Short">Short</option>
                        <option value="Long">Long</option>
                    </select>
                </div>
            `)
                        );

                        newRow.append(
                            $("<td>").html(`
                <div class="textOnInput">
                    <label for="optionLots">Option Lot Size</label>
                    <input type="number" class="option_lot_size_input form-control" value="1">
                </div>
            `)
                        );

                        newRow.append(
                            $("<td>").html(`
                <div class="textOnInput">
                    <label for="ltpValue">LTP Value</label>
                    <input type="number" class="ltpValue_input form-control" value="">
                </div>
            `)
                        );

                        newRow.append(
                            $("<td>").html(`   <i class="delete-btn bi bi-trash-fill"></i>`)
                        );

                        $(".data-display-table").append(newRow);
                    });
                    function populateInputTable(
                        option_side,
                        expiry_date,
                        strike_price,
                        action,
                        option_lot_size,
                        ltpValue,
                        opiton_selected
                    ) {
                        console.log("Option Side:", option_side);
                        console.log("Expiry Date:", expiry_date);
                        console.log("Strike Price:", strike_price);
                        console.log("Action:", action);

                        console.log("Option Lot Size:", option_lot_size);
                        console.log("LTP Value:", ltpValue);
                        console.log("opiton_selected:", opiton_selected);
                        var newRow = $(`
    <tr class="strategy_table_input">
        <td>
            <div class="textOnInput">
                <label for="optionSide">Option Side</label>
                <select class="option_side_input form-select">
                    <option value="Select">Select</option>
                    <option value="Call" ${option_side === "Call" ? "selected" : ""
                            }>Call</option>
                    <option value="Put" ${option_side === "Put" ? "selected" : ""
                            }>Put</option>
                    <option value="Future" ${option_side === "Future" ? "selected" : ""
                            }>Future</option>
                </select>
            </div>
        </td>
        <td>
            <div class="textOnInput">
                <label for="expiryDate">Expiry Date</label>
                <select class="expiry_date_input form-select">
                    <option value="${expiry_date}">${expiry_date}</option>
                </select>
            </div>
        </td>
        <td>
            <div class="textOnInput">
                <label for="strikePrice">Strike Price</label>
                <select class="strike_price_input form-select">
                    <option value="${parseFloat(strike_price)}">${parseFloat(
                                strike_price
                            )}</option>
                </select>
            </div>
        </td>
        <td>
            <div class="textOnInput">
                <label for="action">Action</label>
                <select class="action_input form-select">
                    

                    <option value="Select">Select</option>
         
                    <option value="Long" ${action === "Long" ? "selected" : ""
                            }>Long</option>
                    <option value="Short" ${action === "Short" ? "selected" : ""
                            }>Short</option>
                </select>
            </div>
        </td>
        <td>
            <div class="textOnInput">
                <label for="action">No. of Lots</label>
                <input type="number" class="option_lot_size_input form-control" value="1">
            </div>
        </td>
        <td>
            <div class="textOnInput">
                <label for="action">Traded Price</label>
                <input type="number" class="ltpValue_input form-control" value="${parseFloat(
                                ltpValue
                            )}">
            </div>
        </td>
        <td>   <i class="delete-btn bi bi-trash-fill"></i></td>
    </tr>
`);
                        $(".data-display-table").append(newRow);
                    }

                    // Delete button click handler
                    $(".data-display-table").on("click", ".delete-btn", function () {
                        $(this).closest("tr").remove();
                    });
                },
            });
        }
        setTimeout(loadOptionData(selectedOption, selectedExpiry), 8000);
        function loadExpiryData(selectedOption) {
            console.log("Hi there" + selectedOption);
            $.ajax({
                url: "/option_strategies_expiry",
                method: "GET",
                data: {
                    selected_option: selectedOption,
                },
                success: function (response) {
                    // Process the response from the server here
                    var expiryDates = response.option_date.optionExpiryDate;
                    var expiryStrikes = response.option_strike;
                    populateExpiry_Strike(expiryDates, expiryStrikes);
                },
                error: function (error) {
                    console.error("Error loading expiry data:", error);
                },
            });
        }
        function populateExpiry_Strike(expiryDates, expiryStrikes) {
            // Get the existing selected values before appending new options

            // Populate the select element with expiry dates
            var expirySelect = $(".expiry_date_input");
            var strikeSelect = $(".strike_price_input");

            // Clear existing options
            //             expirySelect.empty();
            // strikeSelect.empty();
            // Add a default "Select" option

            // Add each expiry date as an option
            expiryDates.forEach((expiry) => {
                expirySelect.append(
                    $("<option>", {
                        value: expiry.expiry_date.split("T")[0],
                        text: expiry.expiry_date.split("T")[0],
                    })
                );
            });

            // Add each strike as an option
            expiryStrikes.forEach((strike) => {
                strikeSelect.append(
                    $("<option>", {
                        value: strike,
                        text: strike,
                    })
                );
            });
        }

        function loadStocks(selectedOption) {
            $.ajax({
                url: '{% url "get_stock_symbol" %}',
                type: "GET",
                success: function (data) {
                    var stocksOptgroup = $("#stockDropdown optgroup[label='Stocks']");
                    stocksOptgroup.empty();
                    $.each(data, function (index, stock) {
                        var option = $("<option>").text(stock.symbol_name);
                        stocksOptgroup.append(option);
                    });

                    // If a selectedOption is provided, set it as selected
                    if (selectedOption) {
                        $("#stockDropdown").val(selectedOption);
                    }
                },
            });
        }
    });
</script>

{% endblock dashboard_body %}