{% extends "base_dashboard.html" %}
{% load static %}
{% block dashboard_body %}

<style>
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th,
    td {
        border: 1px solid #ddd;
        padding: 8px;
        /* text-align: left; */
        text-align: center;
    }

    td {
        font-weight: 400 !important;
    }

    th {

        background-color: #4399eb;
        color: white;
    }

    .bx-stats {
        border: 0.5px solid rgba(128, 128, 128, 0.441);
        padding: 5px 10px 1px 5px;
        height: 28px;
        width: 28px;
        border-radius: 7px;
        position: relative;
        transition: 0.3s;
        color: #2c2b2b3c;
    }

    .bx-stats:hover {
        color: white;
        background-color: #4399eb;
    }
</style>

<section>
    <div class="mt-4">
        <h3>Tables for options expiry</h3>

        <div class="d-flex justify-content-between mt-4">
            <div class="stock_exchanges d-flex gap-3">
                <div class="d-flex gap-2">
                    <label for="">Exchanges :</label>
                    <div class="symbol_dropdown">
                        <select id="symbol-dropdown" class="form-select form-select-sm">

                            <option value="NSE">NSE</option>
                            <option value="BSE">BSE</option>
                        </select>
                    </div>
                </div>
                <!-- <div class="indexs">
                    <select id="indices-dropdown" class="form-select form-select-sm">

                    </select>
                </div> -->
            </div>
            <div class="stocks_indices d-flex gap-2 align-items-center">
                <label for="">Days:</label>
                <div>
                    <select id="exp_month-dropdown" class="form-select form-select-sm">
                        <option value="7">7 days</option>
                        <option value="30">30 days</option>
                        <option value="90">90 days</option>
                        <!-- <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">Sep</option>
                        <option value="October">Oct</option>
                        <option value="November">Nov</option>
                        <option value="December">Dec</option> -->
                    </select>
                </div>
            </div>
        </div>

        <table border="1">
            <thead>
                <tr>
                    <th>SNO</th>
                    <th>Expiry Date</th>
                    <th>Index</th>
                    <th>Exchange</th>
                    <th>Chart</th>
                </tr>
            </thead>
            <tbody id="expiry_table">
                <!-- Sample data, replace this with your dynamic data -->

                <!-- Add more rows for additional data -->

            </tbody>
        </table>
</section>

<script>

    $(document).ready(function () {


        var selectedExchange = "NSE";
        var initialSelectedSymbol; // Declare the variable in a higher scope

        $('#symbol-dropdown').on('change', function () {
            selectedExchange = $(this).val();
            // console.log(selectedExchange);
            // get_indices(selectedExchange);

            // get_expiry_lists(selectedExchange);
            storeSymbols(selectedExchange)
        });


        function storeSymbols(selectedExchange) {
    $.ajax({
        url: '/get_indices_data/',
        type: 'POST',
        data: {
            exchange: selectedExchange
        },
        success: function (response) {
            var tbody = $('#expiry_table');
            tbody.empty();

            var selectedDays = parseInt($('#exp_month-dropdown').val(), 10); // Convert selected value to an integer

            for (let i = 0; i < response.symbols.length; i++) {
                let symbol = response.symbols[i];

                if (typeof symbol === 'object') {
                    let nestedSymbol = Object.keys(symbol)[0];
                    console.log("Processing nested symbol:", nestedSymbol);

                    if (symbol[nestedSymbol] && symbol[nestedSymbol].resultData) {
                        let resultData = symbol[nestedSymbol].resultData;
                        console.log("Result Data for", nestedSymbol, ":", resultData);

                        // Display the symbol in the table
                        tbody.append('<tr>' +
                            '<td colspan="5"><strong>' + nestedSymbol + '</strong></td>' +
                            '</tr>');

                        // Loop through resultData and display each date in the table
                        for (let j = 0; j < resultData.length; j++) {
                            let dateObject = new Date(resultData[j]);

                            // Calculate the difference in days
                            let currentDate = new Date();
                            let differenceInDays = Math.floor((currentDate - dateObject) / (1000 * 60 * 60 * 24));

                            // Check if the date is within the selected range of days
                            if (differenceInDays <= selectedDays) {
                                // Get date, month, and year components
                                let day = dateObject.getDate();
                                let month = dateObject.toLocaleString('default', { month: 'long' }); // Full month name
                                let year = dateObject.getFullYear();

                                tbody.append('<tr>' +
                                    '<td>' + (j + 1) + '</td>' +
                                    '<td>' + day + ' ' + month + ' ' + year + '</td>' +
                                    '<td>' + nestedSymbol + '</td>' +
                                    '<td>' + response.exchange + '</td>' +
                                    '<td><a href="#"><i class="bx bx-stats"></i></a></td>' +
                                    '</tr>');
                            }
                        }
                    } else {
                        console.log("No resultData found for", nestedSymbol);
                    }
                }
                // Add any other cases if needed
            }
        },
        error: function (error) {
            console.error('Error storing symbols:', error);
        }
    });
}

        storeSymbols(selectedExchange)


    });

</script>

{% endblock dashboard_body %}