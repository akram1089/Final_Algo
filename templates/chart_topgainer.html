<!DOCTYPE html>
<html>

<head>
    <title>Option Strategies</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
        rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>

</head>

<body>
    <div class="container mt-4 d-flex flex-wrap">
        <div class="col-md-4 mb-4">
            <label for="indexDropdown" class="form-label">Select Index:</label>
            <select class="form-select" id="indexDropdown">
                <option value="NIFTY">NIFTY</option>
                <option value="BANKNIFTY">BANKNIFTY</option>
                <option value="FINNIFTY">FINNIFTY</option>
            </select>
        </div>
        <div class="col-md-4 mb-4">
            <label for="expiryDropdown" class="form-label">Select Expiry Date:</label>
            <select class="form-select" id="expiryDropdown">
                <!-- Data from AJAX will be inserted here -->
            </select>
        </div>
        <div class="col-md-4 mb-4">
            <div class="form-group input-box date-simulator">
                <input type="date" name="startDate" id="startDate" value="2023-07-27"
                    class="border rounded oi-select cursor-pointer fw-500 pt-2 bg-white optimizer-date">
                <label class="form-label fs-13 fw-500 label-color-6">Start Date</label>
            </div>
        </div>
    </div>
    <style>
        .spot_and_pcr_datas {
            display: flex;
        }
    </style>
    <div class="spot_and_pcr_datas">

        <div class="">
            <p>Spot data:</p>

            <span class="spot_data"></span>
        </div>

        <div class="">
            <p>Time:</p>

            <span class="time_data"></span>
        </div>
    </div>


    </div>


    <div class="time_buttons" style="display: flex;">

        <button id="btnOneDayBack">1 day back</button>
        <button id="btnOneDayForward">1 day forwards</button>
        <button id="btn30MintBack">30 mint</button>
        <button id="btn15MintBack">15 mint</button>
        <button id="btn5MintBack">5 mint</button>
        <button id="btn5MintForward">5 mint</button>
        <button id="btn15MintForward">15 mint</button>
        <button id="btn30MintForward">30 mint</button>
    </div>


    <table id="myTable"></table>
<div class="main_profit" class="d-flex">
    <h5>Max Profit :</h5>
    <p id="max_profit"></p>
</div>
<div class="main_loss" class="d-flex">
    <h5>Max Loss :</h5>
    <p id="max_loss">Unlimited</p>
</div>

<div class="min_breakeven d-flex">
    <h5>Min  Breakeven</h5>
<p id="min_breakeven"></p>
</div>
<div class="max_breakeven d-flex">
    <h5>Max  Breakeven</h5>
<p id="max_breakeven"></p>
</div>


    <div class="container mt-4">
        <div id="tableContainer" class="table-responsive">
            <table id="dataTable" class="table">
                <thead>
                    <tr>
                        <th>CALL ACTIONS</th>
                        <th>CALL LTP</th>
                        <th>Symbol Name</th>
                        <th>Expiry Date</th>
                        <th>Strike Price</th>
                        <th>Created At</th>
                        <th>PUT LTP</th>
                        <th>PUT ACTIONS</th>
                        <!-- Add more table headers for other properties -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Table rows will be dynamically added here -->
                </tbody>
            </table>
        </div>
        <div id="noDataMessage" class="mt-3 text-center" style="display: none;">
            Data is not available.
        </div>
    </div>
    <!-- Modal for "CALL ACTIONS" -->
    <div class="modal" tabindex="-1" role="dialog" id="callModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Call Actions</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="call_inst_type">Call_inst_type</label>
                        <input type="text" id="call_inst_type" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group">
                        <label for="callLotSizeInput">Lot Size:</label>
                        <input type="number" id="callLotSizeInput" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group">
                        <label for="call_ltp">Call LTP:</label>
                        <input type="number" id="call_ltp" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group">
                        <label for="call_strike">Call Strike:</label>
                        <input type="number" id="call_strike" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="callAction" id="callBuyRadio" value="buy">
                        <label class="form-check-label" for="callBuyRadio">
                            Buy
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="callAction" id="callSellRadio" value="sell">
                        <label class="form-check-label" for="callSellRadio">
                            Sell
                        </label>
                    </div>
                    <!-- Add additional form fields for "CALL ACTIONS" here -->
                    <div class="counter">
                        <button class="btn btn-counter" id="callMinusBtn">-</button>
                        <input type="number" class="form-control" id="callCounterValue" value="0" min="0">
                        <button class="btn btn-counter" id="callPlusBtn">+</button>
                    </div>
                    <button class="btn btn-primary" id="call_add_position">Add position</button>
                </div>
        
            </div>
        </div>
    </div>

    <!-- Modal for "PUT ACTIONS" -->
    <div class="modal" tabindex="-1" role="dialog" id="putModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Put Actions</h5>
                    <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="put_inst_type">put_inst_type</label>
                        <input type="text" id="put_inst_type" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group">
                        <label for="putLotSizeInput">Lot Size:</label>
                        <input type="number" id="putLotSizeInput" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group">
                        <label for="puts_ltp">puts_ltp:</label>
                        <input type="number" id="puts_ltp" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group">
                        <label for="puts_strike">puts_strike:</label>
                        <input type="number" id="puts_strike" class="form-control" min="1" disabled>
                    </div>


                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="putAction" id="putBuyRadio" value="buy">
                        <label class="form-check-label" for="putBuyRadio">
                            Buy
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="putAction" id="putSellRadio" value="sell">
                        <label class="form-check-label" for="putSellRadio">
                            Sell
                        </label>
                    </div>
                    <!-- Add additional form fields for "PUT ACTIONS" here -->
                    <div class="counter">
                        <button class="btn btn-counter" id="putMinusBtn">-</button>
                        <input type="number" class="form-control" id="putCounterValue" value="0" min="0">
                        <button class="btn btn-counter" id="putPlusBtn">+</button>
                    </div>
                </div>
                <button class="btn btn-primary" id="put_add_position">Add position</button>
    
            </div>
        </div>
    </div>

    <script>


function calculateMaxProfit() {
    // Get all rows from the table
    var tableRows = document.querySelectorAll("#myTable tr");

    // Initialize max profit to 0, min breakeven to Infinity, and max breakeven to -Infinity
    var maxProfit = 0;
    var minBreakeven = Infinity;
    var maxBreakeven = -Infinity;

    // Loop through the rows and calculate the profit
    for (var i = 0; i < tableRows.length; i++) {
        var row = tableRows[i];
        var actionCell = row.children[3].textContent; // Assuming the action cell is the 4th cell (index 3)
        var ltpCell = row.children[1].textContent; // Assuming the ltp cell is the 2nd cell (index 1)
        var lotSizeCell = row.children[2].textContent; // Assuming the lotSize cell is the 3rd cell (index 2)
        var strikePriceCell = row.children[5].textContent; // Assuming the strike price cell is the 6th cell (index 5)

        var ltp = parseFloat(ltpCell);
        var lotSize = parseInt(lotSizeCell);
        var strikePrice = parseFloat(strikePriceCell);

        if (actionCell === "sell" || actionCell === "Sell") { // Consider both "sell" and "Sell"
            var profit = ltp * lotSize;
            maxProfit += profit;

            var minBreakevenValue = strikePrice - ltp;
            var maxBreakevenValue = strikePrice + ltp;

            if (minBreakevenValue < minBreakeven) {
                minBreakeven = minBreakevenValue;
            }

            if (maxBreakevenValue > maxBreakeven) {
                maxBreakeven = maxBreakevenValue;
            }
        }
    }

    // Update the "max_profit" element with the calculated maxProfit
    document.getElementById("max_profit").textContent = "Max Profit: " + maxProfit;

    // Update the "min_breakeven" element with the calculated minBreakeven
    document.getElementById("min_breakeven").textContent = "Min Breakeven: " + minBreakeven;

    // Update the "max_breakeven" element with the calculated maxBreakeven
    document.getElementById("max_breakeven").textContent = "Max Breakeven: " + maxBreakeven;
}

function addPosition(inst_type, lotSize, ltp, action, counterValue,strike_price) {
    // Create table row
    var tableRow = document.createElement("tr");

    // Create table cells and add values
    var inst_typeCell = document.createElement("td");
    inst_typeCell.textContent = inst_type;
    tableRow.appendChild(inst_typeCell);

    var ltpCell = document.createElement("td");
    ltpCell.textContent = ltp;
    tableRow.appendChild(ltpCell);

    var lotSizeCell = document.createElement("td");
    lotSizeCell.textContent = lotSize;
    tableRow.appendChild(lotSizeCell);

    var actionCell = document.createElement("td");
    actionCell.textContent = action;
    tableRow.appendChild(actionCell);

    var counterValueCell = document.createElement("td");
    counterValueCell.textContent = counterValue;
    tableRow.appendChild(counterValueCell);

    var Strike_price_Cell = document.createElement("td");
    Strike_price_Cell.textContent = strike_price;
    tableRow.appendChild(Strike_price_Cell);

    // Create edit and delete buttons
    var editButton = document.createElement("button");
    editButton.textContent = "Edit";
    editButton.addEventListener("click", function() {
        // Add code to edit row here
    });
    tableRow.appendChild(editButton);

    var deleteButton = document.createElement("button");
    deleteButton.textContent = "Delete";
    deleteButton.addEventListener("click", function() {
        // Add code to delete row here
        this.parentNode.parentNode.removeChild(this.parentNode);
        // Recalculate max profit when a row is deleted
        calculateMaxProfit();
    });
    tableRow.appendChild(deleteButton);

    // Append row to table
    document.getElementById("myTable").appendChild(tableRow);

    // Calculate and update max profit when a new position is added
    calculateMaxProfit();
}

document.getElementById("put_add_position").addEventListener("click", function() {
    // Get values from form
    var put_inst_type = document.getElementById("put_inst_type").value;
    var putLotSize = document.getElementById("putLotSizeInput").value;
    var puts_ltp = document.getElementById("puts_ltp").value; // Assuming you have an element with id "puts_ltp"
    var putAction = document.querySelector('input[name="putAction"]:checked').value;
    var putCounterValue = document.getElementById("putCounterValue").value;
    var puts_strike = document.getElementById("puts_strike").value;

    // Call the function to add the position to the table
    addPosition(put_inst_type, putLotSize, puts_ltp, putAction, putCounterValue,puts_strike);
});

document.getElementById("call_add_position").addEventListener("click", function() {
    // Get values from form
    var call_inst_type = document.getElementById("call_inst_type").value;
    var callLotSize = document.getElementById("callLotSizeInput").value;
    var call_ltp = document.getElementById("call_ltp").value; // Assuming you have an element with id "call_ltp"
    var callAction = document.querySelector('input[name="callAction"]:checked').value;
    var callCounterValue = document.getElementById("callCounterValue").value;
    var call_strike = document.getElementById("call_strike").value;

    // Call the function to add the position to the table
    addPosition(call_inst_type, callLotSize, call_ltp, callAction, callCounterValue,call_strike);
});














        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Set the CSRF token as a default header for all AJAX requests
        $.ajaxSetup({
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        });

        // Function to load expiry dates based on the selected index
        function loadExpiryDates(index) {
            const url = `/get_expiry_data/${index}/`;

            $.get(url, function (data) {
                const expiryDropdown = $('#expiryDropdown');
                expiryDropdown.empty();

                $.each(data, function (index, date) {
                    expiryDropdown.append($('<option>').val(date).text(date));
                });

                // Initialize the datepicker with the selected value
                const expiryDateInput = $('#startDate');
                expiryDateInput.val(data[0]);

                // Attach the datepicker to the startDate input field
                expiryDateInput.datepicker({
                    format: 'yyyy-mm-dd',
                    autoclose: true,
                    startDate: data[0], // Set the minimum selectable date
                    endDate: data[data.length - 1], // Set the maximum selectable date
                });

                // Trigger the AJAX request with initial data when page loads

            }).fail(function (error) {
                console.error('Error:', error);
            });
        }
        loadExpiryDates('NIFTY');


        // Event listener for index dropdown change
        $('#indexDropdown').change(function () {
            const selectedValue = $(this).val();
            loadExpiryDates(selectedValue);

        });

        // Event listener for expiry dropdown change
        $('#expiryDropdown').change(function () {
            // Call the function to send the data to Django view
            sendDataToDjango();
        });

        // Event listener for start date change
        $('#startDate').on('input', function () {
            // Call the function to send the data to Django view
            sendDataToDjango();
        });


        $('#btnOneDayBack').click(function () {
            changeStartDate(-1);
        });

        // Event listener for "1 day forwards" button
        $('#btnOneDayForward').click(function () {
            changeStartDate(1);
        });






        function changeStartDate(delta) {
            const startDateInput = $('#startDate');
            const startDateValue = startDateInput.val();

            // Convert the startDateValue to a Date object
            const startDate = new Date(startDateValue);

            // Calculate the new date by adding or subtracting the delta (number of days)
            startDate.setDate(startDate.getDate() + delta);

            // Update the startDateInput value with the new date in yyyy-mm-dd format
            const newStartDateValue = startDate.toISOString().slice(0, 10);
            startDateInput.val(newStartDateValue);

            // Call the function to send the updated data to Django view
            sendDataToDjango();
        }






        // Function to load expiry dates based on the selected index
        function loadExpiryDates(index) {
            const url = `/get_expiry_data/${index}/`;

            $.get(url, function (data) {
                const expiryDropdown = $('#expiryDropdown');
                expiryDropdown.empty();

                $.each(data, function (index, date) {
                    expiryDropdown.append($('<option>').val(date).text(date));
                });

                sendDataToDjango();
            }).fail(function (error) {
                console.error('Error:', error);
            });

        }

        // Event listener for "30 mint" backward button
        $('#btn30MintBack').click(function () {
            changeStartTimeMinutes(-30);
        });

        // Event listener for "15 mint" backward button
        $('#btn15MintBack').click(function () {
            changeStartTimeMinutes(-15);
        });

        // Event listener for "5 mint" backward button
        $('#btn5MintBack').click(function () {
            changeStartTimeMinutes(-5);
        });

        // Event listener for "5 mint" forward button
        $('#btn5MintForward').click(function () {
            changeStartTimeMinutes(5);
        });

        // Event listener for "15 mint" forward button
        $('#btn15MintForward').click(function () {
            changeStartTimeMinutes(15);
        });

        // Event listener for "30 mint" forward button
        $('#btn30MintForward').click(function () {
            changeStartTimeMinutes(30);
        });

        function changeStartTimeMinutes(minutesDelta) {
            console.log(minutesDelta);
            var time = $(".time_data").text();
            console.log(typeof (time));
            const timeParts = time.split(':');
            let hours = parseInt(timeParts[0]);
            let minutes = parseInt(timeParts[1]);

            // Calculate the new time by adding the minutesDelta to the current time
            minutes += minutesDelta;

            // Adjust the hours and minutes when minutes go below 0 or above 59
            if (minutes < 0) {
                minutes += 60;
                hours -= 1;
            } else if (minutes >= 60) {
                minutes -= 60;
                hours += 1;
            }

            // Check if the new time is within the time range of 9:20 to 3:30
            if (hours < 9 || (hours === 9 && minutes < 20)) {
                hours = 9;
                minutes = 20;
                // Disable backward buttons
                $('#btn30MintBack').prop('disabled', true);
                $('#btn15MintBack').prop('disabled', true);
                $('#btn5MintBack').prop('disabled', true);
            } else if (hours > 15 || (hours === 15 && minutes > 30)) {
                hours = 15;
                minutes = 30;
                // Disable forward buttons
                $('#btn5MintForward').prop('disabled', true);
                $('#btn15MintForward').prop('disabled', true);
                $('#btn30MintForward').prop('disabled', true);
            } else {
                // Enable all buttons if the time is within the range
                $('#btn30MintBack').prop('disabled', false);
                $('#btn15MintBack').prop('disabled', false);
                $('#btn5MintBack').prop('disabled', false);
                $('#btn5MintForward').prop('disabled', false);
                $('#btn15MintForward').prop('disabled', false);
                $('#btn30MintForward').prop('disabled', false);
            }

            // Pad the hours and minutes with leading zeros if necessary
            const paddedHours = hours.toString().padStart(2, '0');
            const paddedMinutes = minutes.toString().padStart(2, '0');

            createTime = `${paddedHours}:${paddedMinutes}:00`; // Update the createTime variable
            console.log(createTime);
            // Call the function to send the updated data to Django view
            sendDataToDjango(createTime);
        }

        // Function to send data to Django view
        function sendDataToDjango(createTime) {

            const index = $('#indexDropdown').val();
            const expiryDate = $('#expiryDropdown').val();
            const startDate = $('#startDate').val();

            const data = {
                'index': index,
                'expiryDate': expiryDate,
                'startDate': startDate,
                'createTime': createTime
            };

            // Make AJAX request to send the data to Django view
            $.ajax({
                type: 'POST',
                url: '/option_simulator_data',  // Replace with your Django view URL
                data: data,
                success: function (response) {
                    console.log(response["stock_data"]);
                    var response_spot = response["spot_data"]


                    var lot_size = response_spot["lot_size"]
                    console.log(lot_size);

                    var response = response["stock_data"]
                    var index_close = response.map((x) => {
                        return x.index_close
                    })
                    console.log(index_close[0]);
                    $(".spot_data").text(index_close[0])
                    var cteateTime = response.map((currtime) => {
                        return currtime.time
                    })
                    console.log(cteateTime[0]);
                    $(".time_data").text(cteateTime[0])
                    // Handle the response from Django view




                    displayTable(response, lot_size);
                },
                error: function (error) {
                    console.error('Error:', error);
                }
            });
        }
        function updateCallLotSize(lotSize,call_inst_type,call_ltp,strike_price) {
            $('#callLotSizeInput').val(lotSize);
            $('#call_inst_type').val(call_inst_type);
            $('#call_ltp').val(call_ltp);
            $('#call_strike').val(strike_price);
        }

        // Function to update the lot size in the input field for Put Actions modal
        function updatePutLotSize(lotSize,put_inst_type,puts_ltp,strike_price) {
            $('#putLotSizeInput').val(lotSize);
            $('#put_inst_type').val(put_inst_type);
            $('#puts_ltp').val(puts_ltp);
            $('#puts_strike').val(strike_price);
        }
        function displayTable(data, lot_size) {
            console.log(lot_size);
            const tableBody = $('#tableBody');
            tableBody.empty();

            if (data.length === 0) {
                $('#noDataMessage').show();
                return;
            }

            $('#noDataMessage').hide();
            $(".spot_data").text();
            data.forEach(row => {
                const newRow = $('<tr>');

                // Add buttons for "CALL ACTIONS"
                const callActionsBtn = $('<button>').text('BUY/SELL').attr('data-bs-toggle', 'modal').attr('data-bs-target', '#callModal');
                callActionsBtn.on('click', function () {
                    updateCallLotSize(lot_size,row.call_inst_type,row.calls_ltp,row.strike_price); // Update callLotSizeInput with calls_ltp for this row
          
                });

                // Add buttons for "PUT ACTIONS"
                const putActionsBtn = $('<button>').text('BUY/SELL').attr('data-bs-toggle', 'modal').attr('data-bs-target', '#putModal');
                putActionsBtn.on('click', function () {
                    updatePutLotSize(lot_size,row.put_inst_type,row.puts_ltp,row.strike_price); // Update putLotSizeInput with puts_ltp for this row
                });

                $("#callLotSizeInput").val(row.calls_ltp)
                newRow.append($('<td>').append(callActionsBtn));
                newRow.append($('<td>').append(row.calls_ltp));
                newRow.append($('<td>').text(row.symbol_name));
                newRow.append($('<td>').text(row.expiry_date));
                newRow.append($('<td>').text(row.strike_price));
                newRow.append($('<td>').text(row.created_at));
                newRow.append($('<td>').append(row.puts_ltp));
                newRow.append($('<td>').append(putActionsBtn));

                // Disable buttons when puts_ltp is 0 or calls_ltp is 0
                if (row.puts_ltp === 0) {
                    putActionsBtn.prop('disabled', true);
                }

                if (row.calls_ltp === 0) {
                    callActionsBtn.prop('disabled', true);
                }

                // Add more cells for other properties
                tableBody.append(newRow);
            });

        }
        $(document).ready(function () {
            // For "Call Actions" modal
            let callCounterValue = 1; // Set initial value to 1
            const callCounterInput = $('#callCounterValue');
            callCounterInput.val(callCounterValue); // Set initial value in the input field

            $('#callMinusBtn').click(function () {
                if (callCounterValue > 1) { // Minimum value is 1
                    callCounterValue--;
                    callCounterInput.val(callCounterValue);
                }
            });

            $('#callPlusBtn').click(function () {
                callCounterValue++;
                callCounterInput.val(callCounterValue);
            });

            callCounterInput.change(function () {
                const newValue = parseInt(callCounterInput.val());
                if (!isNaN(newValue) && newValue >= 1) { // Minimum value is 1
                    callCounterValue = newValue;
                } else {
                    callCounterInput.val(callCounterValue);
                }
            });

            // For "Put Actions" modal
            let putCounterValue = 1; // Set initial value to 1
            const putCounterInput = $('#putCounterValue');
            putCounterInput.val(putCounterValue); // Set initial value in the input field

            $('#putMinusBtn').click(function () {
                if (putCounterValue > 1) { // Minimum value is 1
                    putCounterValue--;
                    putCounterInput.val(putCounterValue);
                }
            });

            $('#putPlusBtn').click(function () {
                putCounterValue++;
                putCounterInput.val(putCounterValue);
            });

            putCounterInput.change(function () {
                const newValue = parseInt(putCounterInput.val());
                if (!isNaN(newValue) && newValue >= 1) { // Minimum value is 1
                    putCounterValue = newValue;
                } else {
                    putCounterInput.val(putCounterValue);
                }
            });
        });

    </script>
</body>

</html>