{% extends "base_dashboard.html" %}
{% load static %}
{% block dashboard_body %}
<style>
    .textOnInput {
        position: relative;
        width: 9rem;
    }

    .textOnInput label {
        position: absolute;
        top: -12px;
        font-weight: 700;
        left: 10px;
        padding: 2px;
        color: rgb(56, 56, 56);
        z-index: 1;
        font-size: 12px;
        white-space: nowrap;
    }

    .textOnInput label:after {
        content: " ";
        background-color: #fff;
        width: 100%;
        height: 13px;
        position: absolute;
        left: 0;
        bottom: 0;
        z-index: -1;
    }

    label {
        font-size: 16px;
        font-weight: 500;
        display: inline-block;
        margin-bottom: 0.5rem;
    }

    .form-control {
        box-shadow: none !important;
    }

    .data-display-table {
        display: flex;
        justify-content: center;
        flex-direction: column;
    }

    .put_call_btns:hover {
        background-color: white !important;
        color: #4399eb !important;
    }

    .put_max_profit {
        font-weight: 600;
        font-size: 13px !important;
        color: #21d052 !important;
    }

    .long_max_loss,
    .breakever_probaility_profit {
        font-weight: 600;
        font-size: 13px !important;
    }

    .strategy_cost_table,
    .greek_table {
        padding: 6px 0;
        cursor: pointer;
        font-family: system-ui;
        color: #000000b3;
        font-weight: 600;
    }

    #resultTable thead tr th,
    .PL-table thead tr th {
        color: #000000ad;
        font-size: 13px;
    }

    #resultTable tbody tr td,
    .PL-table tbody tr td {
        color: #000000ad !important;
        font-size: 12px !important;
        font-weight: 600 !important;
    }

    #startDate {
        padding: 4px 11px;

    }

    .left_top_option_simulator {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: center;

    }

    #startDate:focus {
        border: 1px solid red !important;
    }

    .title_lot_size,
    .pcr,
    .spot {
        font-weight: 600;
        color: #495057 !important;
        font-size: 13px !important;
    }

    .lot_size_value,
    .pcr_value,
    .spot_value {
        font-weight: 600;
        color: #767f88;
    }
</style>
<style>
    .spot_and_pcr_datas {
        display: flex;
    }

    #btnOneDayBack,
    #btn30MintBack,
    #btn15MintBack,
    #btn5MintBack,
    #btn5MintForward,
    #btn15MintForward,
    #btn30MintForward,
    #btnOneDayForward {
        display: flex;
        align-items: center;
        height: 30px;
        font-size: 13px;
        width: 80px;
        white-space: nowrap;
        font-weight: 600;
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
        outline: 0 !important;
        -webkit-transition: all .2s ease-in-out !important;
        -moz-transition: all .2s ease-in-out !important;
        transition: all .2s ease-in-out !important;
        background: linear-gradient(180deg, #4399eb, #5cadfb) !important;
        color: #fff !important;
        border-radius: 3px;
        border: 1px solid #4399eb !important;
        justify-content: center;
    }


    #btnOneDayBack:hover,
    #btn30MintBack:hover,
    #btn15MintBack:hover,
    #btn5MintBack:hover,
    #btn5MintForward:hover,
    #btn15MintForward:hover,
    #btn30MintForward:hover,
    #btnOneDayForward:hover,
    #btnOneDayBack:focus,
    #btn30MintBack:focus,
    #btn15MintBack:focus,
    #btn5MintBack:focus,
    #btn5MintForward:focus,
    #btn15MintForward:focus,
    #btn30MintForward:focus,
    #btnOneDayForward:focus {
        background: white !important;
        /* Background color for hover and focus states */
        color: #4399eb !important;
        /* Text color for hover and focus states */
        border: 1px solid #4399eb !important;
    }

    .left_option_simulator_btn,
    .right_option_simulator_btn {

        display: flex !important;
        column-gap: 1rem !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
        row-gap: 0.3rem;

    }

    .bx-chevron-left,
    .bx-chevron-right {
        font-family: boxicons !important;
        font-weight: 500 !important;
        font-style: normal;
        font-variant: normal;
        line-height: 1;
        text-rendering: auto;
        display: inline-block;
        font-size: 24px !important;
        text-transform: none;
        -webkit-font-smoothing: antialiased;
    }

    .middle_date_time {
        display: flex;
        gap: 0.2rem;
        font-size: 14px;
        font-weight: 600;
        color: #767f88;

    }

    .option_simulator_strategy {

        /* height: 34px; */
        color: #4399eb;
        border: 1px solid #4399eb;
        background-color: #fff;
        -webkit-box-shadow: none !important;
        box-shadow: none !important;
        -webkit-transition: .3s !important;
        -moz-transition: .3s !important;
        transition: .3s !important;
        outline: 0 !important;
        text-align: center;
        padding: 6px 10px;
        font-size: 14px;
        border-radius: 5px;
        font-weight: 500;
        white-space: nowrap;
        cursor: pointer;
    }

    .option_simulator_strategy:hover {
        background: -webkit-gradient(linear, left top, left bottom, from(#4399eb), to(#5cadfb));
        background: -moz-linear-gradient(top, #4399eb, #5cadfb);
        background: linear-gradient(180deg, #4399eb, #5cadfb);
        color: #fff;
    }

    .main_top_strategy_optimizer {
        display: flex !important;
        column-gap: 1rem !important;
        row-gap: 0.5rem;
        margin-top: 1rem;
        align-items: center;
    }

    .All_strategy_builder {
        margin-top: 1rem;
        display: flex;
        column-gap: 1rem;
        align-items: flex-end;
        row-gap: 0.3rem;
        flex-wrap: wrap;
    }

    .simulator-header {
        padding: 3px 0;
    }

    .bg-light-green {
        background-color: #c9ffed !important;
    }

    .bg-light-red {
        background-color: #ffd2cf !important;
    }

    .nifty-table th {
        color: #495057;
        font-size: 12px;
        padding: 10px 14px !important;
        border-top: 1px solid #dee2e6;
        white-space: nowrap;
    }

    .nifty-table td {
        color: #495057 !important;
        font-size: 12px;
        padding: 10px 14px !important;
        border-top: 1px solid #dee2e6;
        white-space: nowrap;
        font-weight: 400;
    }

    .bg-above {
        background-color: #fbf5cd !important;
    }

    .bg-below {
        background-color: #fbf5cd !important;
    }

    .calls_action_btn {
        height: 31px;
        font-weight: 700;
        color: #5f5f5f;
        border: 1px solid darkgray;
        border-radius: 7px;
        background: #C9FFED;
        font-size: 11px;
    }

    .puts_action_btn {
        height: 31px;
        font-weight: 700;
        color: #5f5f5f;
        border: 1px solid darkgray;
        border-radius: 7px;
        background: #FFD2CF;
        font-size: 11px;
    }

    #table-hover tbody tr:hover {
        z-index: -1 !important;
        background: rgba(248, 249, 250);
    }
    .modal{
        z-index: 999999999999 !important;
    }
</style>

<body>
    <div class=" mt-4 mb-2 d-flex flex-wrap justify-content-between main_top_strategy_optimizer">
        <div class="left_top_option_simulator">
            <div class="textOnInput">
                <label for="indexDropdown" class="form-label">Symbol:</label>
                <select class="option_side_input form-select" id="indexDropdown">
                    <option value="NIFTY">NIFTY</option>
                    <option value="BANKNIFTY">BANKNIFTY</option>
                    <option value="FINNIFTY">FINNIFTY</option>
                </select>




            </div>
            <div class="textOnInput">
                <label for="expiryDropdown" class="form-label">Expiry:</label>
                <select class="form-select" id="expiryDropdown">
                    <!-- Data from AJAX will be inserted here -->
                </select>
            </div>
            <div class="lot_size d-block">
                <div class="title_lot_size">Lot Size</div>
                <div class="lot_size_value">

                </div>
            </div>
            <div class="pcr d-block">
                <div class="title_pcr">PCR</div>
                <div class="pcr_value">
                    1.89
                </div>
            </div>

            <div class="spot d-block">
                <div class="title_spot">Spot</div>
                <div class="spot_value">

                </div>
            </div>



        </div>
        <div class="right_top_option_simulator">
            <div class="textOnInput">
                <div class="form-group input-box date-simulator">
                    <label class="form-label fs-13 fw-500 label-color-6">Start Date</label>
                    <input type="date" name="startDate" id="startDate"
                        class="border rounded oi-select cursor-pointer fw-500 pt-2 bg-white optimizer-date">
                </div>
            </div>

        </div>




    </div>



    </div>


    <div class=" time_buttons" style="display: flex; justify-content: space-between; align-items: center">


        <div class="left_option_simulator_btn">

            <button id="btnOneDayBack"> <i class='bx bx-chevron-left'></i>1 Day</button>
            <button id="btn30MintBack"><i class='bx bx-chevron-left'></i>30 Min</button>
            <button id="btn15MintBack"><i class='bx bx-chevron-left'></i>15 Min</button>
            <button id="btn5MintBack"><i class='bx bx-chevron-left'></i>5 Min</button>
        </div>
        <div class="middle_date_time">
            <div class="date_formated">


            </div>
            <div class="time_formated">

            </div>

        </div>

        <div class="right_option_simulator_btn">

            <button id="btn5MintForward">5 Min <i class='bx bx-chevron-right'></i></button>
            <button id="btn15MintForward">15 Min <i class='bx bx-chevron-right'></i></button>
            <button id="btn30MintForward">30 Min <i class='bx bx-chevron-right'></i></button>
            <button id="btnOneDayForward">1 Day <i class='bx bx-chevron-right'></i> </button>

        </div>

    </div>

    <div class=" d-flex justify-content-center All_strategy_builder">

        <h6 class="fw-bold" style="color: #495057;">Pre Built :</h6>

        <div class="option_simulator_strategy straddle">
            STRADDLE
        </div>
        <div class="option_simulator_strategy straddle">
            STRANGLE
        </div>
        <div class="option_simulator_strategy straddle">
            SPREAD
        </div>
        <div class="option_simulator_strategy straddle">
            IRON FLY
        </div>
        <div class="option_simulator_strategy straddle">
            IRON CONDOR
        </div>
        <div class="option_simulator_strategy straddle">
            JADE LIZARD
        </div>





    </div>

    <div class=" expiry_Note d-flex justify-content-between my-2 fw-bold flex-wrap">

        <h6>Note:-*For respected strike prices, the Gamma and Vega greeks are the same for Calls and Puts</h6>
        <div class="option_chain_expiry d-flex">

            <h6 class="expiry_inner_option_chain"></h6>

            <h6>- Option Chain</h6>
        </div>

    </div>

    <div class=" option_chain_optimiser table-responsive">

        <table class="table nifty-table" id="table-hover">
            <thead>
                <tr class="simulator-main-header bg-light">
                    <th colspan="9">
                        <div class="simulator-header text-center"><span
                                class="label-color-5 fw-500 fs-14 mb-0">CALLS</span>
                        </div>
                    </th>
                    <th colspan="1"></th>
                    <th colspan="10">
                        <div class="simulator-header text-center"><span
                                class="label-color-5 fw-500 fs-14 mb-0">PUTS</span>
                        </div>
                    </th>
                </tr>
                <tr>
                    <th class="bg-light-green fw-500 text-center">ACTIONS</th>
                    <th class="bg-light-green fw-500 text-end">RHO</th>
                    <th class="bg-light-green fw-500 text-end">THETA</th>
                    <th class="bg-light-green fw-500 text-end">DELTA</th>
                    <th class="bg-light-green fw-500 text-end">OI</th>
                    <th class="bg-light-green fw-500 text-end">CHG OI</th>
                    <th class="bg-light-green fw-500 text-end">LTP</th>

                    <th class="bg-light fw-500 text-center">VEGA*</th>
                    <th class="bg-light fw-500 text-center">STRIKE</th>
                    <th class="bg-light fw-500 text-center">GAMMA*</th>

                    <th class="bg-light-red fw-500 text-end">LTP</th>
                    <th class="bg-light-red fw-500 text-end">CHG OI</th>
                    <th class="bg-light-red fw-500 text-end">OI</th>
                    <th class="bg-light-red fw-500 text-end">DELTA</th>
                    <th class="bg-light-red fw-500 text-end">THETA</th>
                    <th class="bg-light-red fw-500 text-end">RHO</th>
                    <th class="bg-light-red fw-500 text-end">PCR</th>
                    <th class="bg-light-red fw-500 text-center">ACTIONS</th>
                </tr>
            </thead>

            <tbody class="option_simulator_body"></tbody>
        </table>
    </div>













    <table id="myTable"></table>
    <div class="main_profit" class="d-flex">
        <h5>Max Profit :</h5>
        <p id="max_profit"></p>
    </div>
    <div class="main_loss" class="d-flex">
        <h5>Max Loss :</h5>
        <p id="max_loss">Unlimited</p>
    </div>

    <div class="min_breakeven d-flex">
        <h5>Min Breakeven</h5>
        <p id="min_breakeven"></p>
    </div>
    <div class="max_breakeven d-flex">
        <h5>Max Breakeven</h5>
        <p id="max_breakeven"></p>
    </div>



    <div id="noDataMessage" class="mt-3 text-center" style="display: none;">
        Data is not available.
    </div>
    </div> -->
    <!-- Modal for "CALL ACTIONS" -->
    <div class="modal" tabindex="-1" role="dialog" id="callModal">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Call Actions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="call_inst_type">Call_inst_type</label>
                        <input type="text" id="call_inst_type" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group d-none">
                        <label for="callLotSizeInput">Lot Size:</label>
                        <input type="number" id="callLotSizeInput" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group d-none">
                        <label for="call_ltp">Call LTP:</label>
                        <input type="number" id="call_ltp" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group d-none">
                        <label for="call_strike">Call Strike:</label>
                        <input type="number" id="call_strike" class="form-control" min="1" disabled>
                    </div>

                    <div class="main_call_modal_body d-flex">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="callAction" id="callBuyRadio" value="buy" checked>
                            <label class="form-check-label" for="callBuyRadio">
                                Buy
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="callAction" id="callSellRadio" value="sell">
                            <label class="form-check-label" for="callSellRadio">
                                Sell
                            </label>
                        </div>
                        <!-- Add additional form fields for "CALL ACTIONS" here -->
                        <div class="counter">
                            <button class="btn btn-counter" id="callMinusBtn">-</button>
                            <input type="number" class="form-control" id="callCounterValue" value="0" min="0">
                            <div id="callCounterValue"></div>
                            <button class="btn btn-counter" id="callPlusBtn">+</button>
                        </div>


                    </div>
                 
                    <button class="btn btn-primary" id="call_add_position">Add position</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal for "PUT ACTIONS" -->
    <div class="modal" tabindex="-1" role="dialog" id="putModal">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Put Actions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="put_inst_type">put_inst_type</label>
                        <input type="text" id="put_inst_type" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group">
                        <label for="putLotSizeInput">Lot Size:</label>
                        <input type="number" id="putLotSizeInput" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group">
                        <label for="puts_ltp">puts_ltp:</label>
                        <input type="number" id="puts_ltp" class="form-control" min="1" disabled>
                    </div>
                    <div class="form-group">
                        <label for="puts_strike">puts_strike:</label>
                        <input type="number" id="puts_strike" class="form-control" min="1" disabled>
                    </div>


                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="putAction" id="putBuyRadio" value="buy">
                        <label class="form-check-label" for="putBuyRadio">
                            Buy
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="putAction" id="putSellRadio" value="sell">
                        <label class="form-check-label" for="putSellRadio">
                            Sell
                        </label>
                    </div>
                    <!-- Add additional form fields for "PUT ACTIONS" here -->
                    <div class="counter">
                        <button class="btn btn-counter" id="putMinusBtn">-</button>
                        <input type="number" class="form-control" id="putCounterValue" value="0" min="0">
                        <button class="btn btn-counter" id="putPlusBtn">+</button>
                    </div>
                </div>
                <button class="btn btn-primary" id="put_add_position">Add position</button>

            </div>
        </div>
    </div>

    <script>


        function calculateMaxProfit() {
            // Get all rows from the table
            var tableRows = document.querySelectorAll("#myTable tr");

            // Initialize max profit to 0, min breakeven to Infinity, and max breakeven to -Infinity
            var maxProfit = 0;
            var minBreakeven = Infinity;
            var maxBreakeven = -Infinity;

            // Loop through the rows and calculate the profit
            for (var i = 0; i < tableRows.length; i++) {
                var row = tableRows[i];
                var actionCell = row.children[3].textContent; // Assuming the action cell is the 4th cell (index 3)
                var ltpCell = row.children[1].textContent; // Assuming the ltp cell is the 2nd cell (index 1)
                var lotSizeCell = row.children[2].textContent; // Assuming the lotSize cell is the 3rd cell (index 2)
                var strikePriceCell = row.children[5].textContent; // Assuming the strike price cell is the 6th cell (index 5)

                var ltp = parseFloat(ltpCell);
                var lotSize = parseInt(lotSizeCell);
                var strikePrice = parseFloat(strikePriceCell);

                if (actionCell === "sell" || actionCell === "Sell") { // Consider both "sell" and "Sell"
                    var profit = ltp * lotSize;
                    maxProfit += profit;

                    var minBreakevenValue = strikePrice - ltp;
                    var maxBreakevenValue = strikePrice + ltp;

                    if (minBreakevenValue < minBreakeven) {
                        minBreakeven = minBreakevenValue;
                    }

                    if (maxBreakevenValue > maxBreakeven) {
                        maxBreakeven = maxBreakevenValue;
                    }
                }
            }

            // Update the "max_profit" element with the calculated maxProfit
            document.getElementById("max_profit").textContent = "Max Profit: " + maxProfit;

            // Update the "min_breakeven" element with the calculated minBreakeven
            document.getElementById("min_breakeven").textContent = "Min Breakeven: " + minBreakeven;

            // Update the "max_breakeven" element with the calculated maxBreakeven
            document.getElementById("max_breakeven").textContent = "Max Breakeven: " + maxBreakeven;
        }

        function addPosition(inst_type, lotSize, ltp, action, counterValue, strike_price) {
            // Create table row
            var tableRow = document.createElement("tr");

            // Create table cells and add values
            var inst_typeCell = document.createElement("td");
            inst_typeCell.textContent = inst_type;
            tableRow.appendChild(inst_typeCell);

            var ltpCell = document.createElement("td");
            ltpCell.textContent = ltp;
            tableRow.appendChild(ltpCell);

            var lotSizeCell = document.createElement("td");
            lotSizeCell.textContent = lotSize;
            tableRow.appendChild(lotSizeCell);

            var actionCell = document.createElement("td");
            actionCell.textContent = action;
            tableRow.appendChild(actionCell);

            var counterValueCell = document.createElement("td");
            counterValueCell.textContent = counterValue;
            tableRow.appendChild(counterValueCell);

            var Strike_price_Cell = document.createElement("td");
            Strike_price_Cell.textContent = strike_price;
            tableRow.appendChild(Strike_price_Cell);

            // Create edit and delete buttons
            var editButton = document.createElement("button");
            editButton.textContent = "Edit";
            editButton.addEventListener("click", function () {
                // Add code to edit row here
            });
            tableRow.appendChild(editButton);

            var deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.addEventListener("click", function () {
                // Add code to delete row here
                this.parentNode.parentNode.removeChild(this.parentNode);
                // Recalculate max profit when a row is deleted
                calculateMaxProfit();
            });
            tableRow.appendChild(deleteButton);

            // Append row to table
            document.getElementById("myTable").appendChild(tableRow);

            // Calculate and update max profit when a new position is added
            calculateMaxProfit();
        }

        document.getElementById("put_add_position").addEventListener("click", function () {
            // Get values from form
            var put_inst_type = document.getElementById("put_inst_type").value;
            var putLotSize = document.getElementById("putLotSizeInput").value;
            var puts_ltp = document.getElementById("puts_ltp").value; // Assuming you have an element with id "puts_ltp"
            var putAction = document.querySelector('input[name="putAction"]:checked').value;
            var putCounterValue = document.getElementById("putCounterValue").value;
            var puts_strike = document.getElementById("puts_strike").value;

            // Call the function to add the position to the table
            addPosition(put_inst_type, putLotSize, puts_ltp, putAction, putCounterValue, puts_strike);
        });

        document.getElementById("call_add_position").addEventListener("click", function () {
            // Get values from form
            var call_inst_type = document.getElementById("call_inst_type").value;
            var callLotSize = document.getElementById("callLotSizeInput").value;
            var call_ltp = document.getElementById("call_ltp").value; // Assuming you have an element with id "call_ltp"
            var callAction = document.querySelector('input[name="callAction"]:checked').value;
            var callCounterValue = document.getElementById("callCounterValue").value;
            var call_strike = document.getElementById("call_strike").value;

            // Call the function to add the position to the table
            addPosition(call_inst_type, callLotSize, call_ltp, callAction, callCounterValue, call_strike);
        });














        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Set the CSRF token as a default header for all AJAX requests
        $.ajaxSetup({
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        });

        // Function to load expiry dates based on the selected index
        function loadExpiryDates(index) {
            const url = `/get_expiry_data/${index}/`;

            $.get(url, function (data) {
                const expiryDropdown = $('#expiryDropdown');
                expiryDropdown.empty();

                $.each(data, function (index, date) {
                    expiryDropdown.append($('<option>').val(date).text(date));
                });

                // Initialize the datepicker with the selected value
                const expiryDateInput = $('#startDate');
                expiryDateInput.val(data[0]);

                // Attach the datepicker to the startDate input field
                expiryDateInput.datepicker({
                    format: 'yyyy-mm-dd',
                    autoclose: true,
                    startDate: data[0], // Set the minimum selectable date
                    endDate: data[data.length - 1], // Set the maximum selectable date
                });

                // Trigger the AJAX request with initial data when page loads

            }).fail(function (error) {
                console.error('Error:', error);
            });
        }
        loadExpiryDates('NIFTY');


        // Event listener for index dropdown change
        $('#indexDropdown').change(function () {
            const selectedValue = $(this).val();
            loadExpiryDates(selectedValue);

        });

        // Event listener for expiry dropdown change
        $('#expiryDropdown').change(function () {
            // Call the function to send the data to Django view
            sendDataToDjango();
        });

        // Event listener for start date change
        $('#startDate').on('input', function () {
            // Call the function to send the data to Django view
            sendDataToDjango();
        });


        $('#btnOneDayBack').click(function () {
            changeStartDate(-1);
        });

        // Event listener for "1 day forwards" button
        $('#btnOneDayForward').click(function () {
            changeStartDate(1);
        });






        function changeStartDate(delta) {
            const startDateInput = $('#startDate');
            const startDateValue = startDateInput.val();

            // Convert the startDateValue to a Date object
            const startDate = new Date(startDateValue);

            // Calculate the new date by adding or subtracting the delta (number of days)
            startDate.setDate(startDate.getDate() + delta);

            // Update the startDateInput value with the new date in yyyy-mm-dd format
            const newStartDateValue = startDate.toISOString().slice(0, 10);
            startDateInput.val(newStartDateValue);

            // Call the function to send the updated data to Django view
            sendDataToDjango();
        }






        // Function to load expiry dates based on the selected index
        // Function to load expiry dates based on the selected index
        function loadExpiryDates(index) {
            const url = `/get_expiry_data/${index}/`;

            $.get(url, function (data) {
                const expiryDropdown = $('#expiryDropdown');
                expiryDropdown.empty();

                // Sort the data array in ascending order
                data.sort((a, b) => new Date(a) - new Date(b));

                // Create a new Date object representing the current date
                const currentDate = new Date();

                // Initialize variables for closest and previous dates
                let closestDate = null;
                let previousClosestDate = null;

                // Find the closest date prior to the current date
                data.forEach(date => {
                    const dateObj = new Date(date);

                    if (dateObj < currentDate) {
                        previousClosestDate = closestDate;
                        closestDate = date;
                    }
                });

                // Log the closest and previous closest dates
                console.log("Previous Closest Date:", previousClosestDate);
                console.log("Closest Date:", closestDate);
                $(".expiry_inner_option_chain").text(closestDate)
                $("#startDate").val(previousClosestDate)
                var formatedString = previousClosestDate


                const formattedPreviousClosestDate = formatedString
                    ? new Date(formatedString).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    })
                    : '';
                console.log(formattedPreviousClosestDate);
                $(".date_formated").text(formattedPreviousClosestDate)

                // Populate the dropdown options and set 'selected' property
                data.forEach(date => {
                    const option = $('<option>').val(date).text(date);
                    option.prop('selected', date === closestDate);
                    expiryDropdown.append(option);
                });

                sendDataToDjango();
            }).fail(function (error) {
                console.error('Error:', error);
            });
        }


        // Event listener for "30 mint" backward button
        $('#btn30MintBack').click(function () {
            changeStartTimeMinutes(-30);
        });

        // Event listener for "15 mint" backward button
        $('#btn15MintBack').click(function () {
            changeStartTimeMinutes(-15);
        });

        // Event listener for "5 mint" backward button
        $('#btn5MintBack').click(function () {
            changeStartTimeMinutes(-5);
        });

        // Event listener for "5 mint" forward button
        $('#btn5MintForward').click(function () {
            changeStartTimeMinutes(5);
        });

        // Event listener for "15 mint" forward button
        $('#btn15MintForward').click(function () {
            changeStartTimeMinutes(15);
        });

        // Event listener for "30 mint" forward button
        $('#btn30MintForward').click(function () {
            changeStartTimeMinutes(30);
        });

        function changeStartTimeMinutes(minutesDelta) {
            console.log(minutesDelta);
            var time = $(".time_formated").text();
            console.log(typeof (time));
            const timeParts = time.split(':');
            let hours = parseInt(timeParts[0]);
            let minutes = parseInt(timeParts[1]);

            // Calculate the new time by adding the minutesDelta to the current time
            minutes += minutesDelta;

            // Adjust the hours and minutes when minutes go below 0 or above 59
            if (minutes < 0) {
                minutes += 60;
                hours -= 1;
            } else if (minutes >= 60) {
                minutes -= 60;
                hours += 1;
            }

            // Check if the new time is within the time range of 9:20 to 3:30
            if (hours < 9 || (hours === 9 && minutes < 20)) {
                hours = 9;
                minutes = 20;
                // Disable backward buttons
                $('#btn30MintBack').prop('disabled', true);
                $('#btn15MintBack').prop('disabled', true);
                $('#btn5MintBack').prop('disabled', true);
            } else if (hours > 15 || (hours === 15 && minutes > 30)) {
                hours = 15;
                minutes = 30;
                // Disable forward buttons
                $('#btn5MintForward').prop('disabled', true);
                $('#btn15MintForward').prop('disabled', true);
                $('#btn30MintForward').prop('disabled', true);
            } else {
                // Enable all buttons if the time is within the range
                $('#btn30MintBack').prop('disabled', false);
                $('#btn15MintBack').prop('disabled', false);
                $('#btn5MintBack').prop('disabled', false);
                $('#btn5MintForward').prop('disabled', false);
                $('#btn15MintForward').prop('disabled', false);
                $('#btn30MintForward').prop('disabled', false);
            }

            // Pad the hours and minutes with leading zeros if necessary
            const paddedHours = hours.toString().padStart(2, '0');
            const paddedMinutes = minutes.toString().padStart(2, '0');

            createTime = `${paddedHours}:${paddedMinutes}:00`; // Update the createTime variable
            console.log(createTime);
            // Call the function to send the updated data to Django view
            sendDataToDjango(createTime);
        }

        // Function to send data to Django view
        function sendDataToDjango(createTime) {

            const index = $('#indexDropdown').val();
            const expiryDate = $('#expiryDropdown').val();
            const startDate = $('#startDate').val();

            const data = {
                'index': index,
                'expiryDate': expiryDate,
                'startDate': startDate,
                'createTime': createTime
            };

            // Make AJAX request to send the data to Django view
            $.ajax({
                type: 'GET',
                url: '/option_simulator_data',  // Replace with your Django view URL
                data: data,
                success: function (response) {
                    console.log(response["stock_data"]);
                    var response_spot = response["spot_data"]


                    var lot_size = response_spot["lot_size"]
                    console.log(response_spot);
                    $(".lot_size_value").text(lot_size)




                    var response = response["stock_data"]
                    var index_close = response.map((x) => {
                        return x.index_close
                    })
                    console.log(index_close);
                    $(".spot_value").text(index_close[0])
                    $(".spot_data").text(index_close[0])

                    var cteateTime = response.map((currtime) => {
                        return currtime.time
                    })
                    console.log(cteateTime[0]);
                    $(".time_formated").text(cteateTime[0])
                    // Handle the response from Django view


                    displayTable(response, lot_size, index_close[0]);
                },
                error: function (error) {
                    console.error('Error:', error);
                }
            });
        }
        function updateCallLotSize(lotSize, call_inst_type, call_ltp, strike_price) {
            $('#callLotSizeInput').val(lotSize);
            $('#call_inst_type').val(call_inst_type);
            $('#call_ltp').val(call_ltp);
            $('#call_strike').val(strike_price);
        }

        // Function to update the lot size in the input field for Put Actions modal
        function updatePutLotSize(lotSize, put_inst_type, puts_ltp, strike_price) {
            $('#putLotSizeInput').val(lotSize);
            $('#put_inst_type').val(put_inst_type);
            $('#puts_ltp').val(puts_ltp);
            $('#puts_strike').val(strike_price);
        }
        function displayTable(data, lot_size, spot_strike) {
            console.log(lot_size);
            const tableBody = $('.option_simulator_body');
            tableBody.empty();

            if (data.length === 0) {
                $('#noDataMessage').show();
                return;
            }

            $('#noDataMessage').hide();
            $(".spot_data").text();
            data.forEach(row => {
                var top_bg_left = row.strike_price < spot_strike ? "bg-above" : "";
                var bottom_bg_right = row.strike_price > spot_strike ? "bg-below" : "";
                const newRow = $('<tr>');
                var text_center = "text-center"
                var text_end = "text-end"
                // Add buttons for "CALL ACTIONS"
                const callActionsBtn = $('<button>').addClass("calls_action_btn").text('BUY/SELL').attr('data-bs-toggle', 'modal').attr('data-bs-target', '#callModal');
                callActionsBtn.on('click', function () {
                    updateCallLotSize(lot_size, row.call_inst_type, row.calls_ltp, row.strike_price); // Update callLotSizeInput with calls_ltp for this row
                });

                // Add buttons for "PUT ACTIONS"
                const putActionsBtn = $('<button>').addClass("puts_action_btn").text('BUY/SELL').attr('data-bs-toggle', 'modal').attr('data-bs-target', '#putModal');
                putActionsBtn.on('click', function () {
                    updatePutLotSize(lot_size, row.put_inst_type, row.puts_ltp, row.strike_price); // Update putLotSizeInput with puts_ltp for this row
                });

                $("#callLotSizeInput").val(row.calls_ltp);

                // Function to replace 0 with "-"
                function replaceZeroWithDash(value) {
                    return value === 0 ? "-" : value;
                }

                newRow.append($('<td>').addClass(top_bg_left + ' ' + text_center).append(callActionsBtn));
                newRow.append($('<td>').addClass(top_bg_left + ' ' + text_end).append(replaceZeroWithDash(row.calls_rho)));

                newRow.append($('<td>').addClass(top_bg_left + ' ' + text_end).append(replaceZeroWithDash(row.calls_theta)));
                newRow.append($('<td>').addClass(top_bg_left + ' ' + text_end).append(replaceZeroWithDash(row.calls_delta)));
                newRow.append($('<td>').addClass(top_bg_left + ' ' + text_end).append(replaceZeroWithDash(row.calls_oi)));
                newRow.append($('<td>').addClass(top_bg_left + ' ' + text_end).append(replaceZeroWithDash(row.calls_change_oi)));
                newRow.append($('<td>').addClass(top_bg_left + ' ' + text_end).append(replaceZeroWithDash(row.calls_ltp)));

                newRow.append($('<td>').addClass("bg-light text-center").text(replaceZeroWithDash(row.calls_vega)));
                newRow.append($('<td>').addClass("bg-light text-center").text(replaceZeroWithDash(row.strike_price)));
                newRow.append($('<td>').addClass("bg-light text-center").text(replaceZeroWithDash(row.puts_gamma)));

                newRow.append($('<td>').addClass(bottom_bg_right + ' ' + text_end).text(replaceZeroWithDash(row.puts_ltp)));
                newRow.append($('<td>').addClass(bottom_bg_right + ' ' + text_end).text(replaceZeroWithDash(row.puts_change_oi)));
                newRow.append($('<td>').addClass(bottom_bg_right + ' ' + text_end).text(replaceZeroWithDash(row.puts_oi)));
                newRow.append($('<td>').addClass(bottom_bg_right + ' ' + text_end).text(replaceZeroWithDash(row.puts_delta)));
                newRow.append($('<td>').addClass(bottom_bg_right + ' ' + text_end).text(replaceZeroWithDash(row.puts_theta)));
                newRow.append($('<td>').addClass(bottom_bg_right + ' ' + text_end).text(replaceZeroWithDash(row.puts_rho)));
                newRow.append($('<td>').addClass(bottom_bg_right + ' ' + text_end).text(replaceZeroWithDash(row.pcr)));

                newRow.append($('<td>').addClass(bottom_bg_right).append(putActionsBtn));

                // Disable buttons when puts_ltp is 0 or calls_ltp is 0
                if (row.puts_ltp === 0) {
                    putActionsBtn.prop('disabled', true);
                }

                if (row.calls_ltp === 0) {
                    callActionsBtn.prop('disabled', true);
                }

                // Add more cells for other properties
                tableBody.append(newRow);
            });
        }

        $(document).ready(function () {
            // For "Call Actions" modal
            let callCounterValue = 1; // Set initial value to 1
            const callCounterInput = $('#callCounterValue');
            callCounterInput.val(callCounterValue); // Set initial value in the input field

            $('#callMinusBtn').click(function () {
                if (callCounterValue > 1) { // Minimum value is 1
                    callCounterValue--;
                    callCounterInput.val(callCounterValue);
                    callCounterInput.text(callCounterValue);

                }
            });

            $('#callPlusBtn').click(function () {
                callCounterValue++;
                callCounterInput.val(callCounterValue);
                callCounterInput.text(callCounterValue);
            });

            callCounterInput.change(function () {
                const newValue = parseInt(callCounterInput.val());
                if (!isNaN(newValue) && newValue >= 1) { // Minimum value is 1
                    callCounterValue = newValue;
                } else {
                    callCounterInput.val(callCounterValue);
                    callCounterInput.text(callCounterValue);
                }
            });

            // For "Put Actions" modal
            let putCounterValue = 1; // Set initial value to 1
            const putCounterInput = $('#putCounterValue');
            putCounterInput.val(putCounterValue); // Set initial value in the input field

            $('#putMinusBtn').click(function () {
                if (putCounterValue > 1) { // Minimum value is 1
                    putCounterValue--;
                    putCounterInput.val(putCounterValue);
                    putCounterInput.text(putCounterValue);
                }
            });

            $('#putPlusBtn').click(function () {
                putCounterValue++;
                putCounterInput.val(putCounterValue);
                putCounterInput.text(putCounterValue);
            });

            putCounterInput.change(function () {
                const newValue = parseInt(putCounterInput.val());
                if (!isNaN(newValue) && newValue >= 1) { // Minimum value is 1
                    putCounterValue = newValue;
                } else {
                    putCounterInput.val(putCounterValue);
                }
            });
        });

    </script>
</body>

{% endblock dashboard_body %}